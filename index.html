<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Project Central — Mock Mode</title>
<style>
/* ====== TOKENS ====== */
:root{
  --bg:#0b0f1c; --bg-2:#0e1324; --panel: rgba(255,255,255,.06);
  --ink:#f2f4ff; --muted:#b6b9d9; --pri:#7aa2ff; --pri-ink:#0a0f23;
  --ok:#2ecc71; --warn:#ffb74d; --err:#ff6d8c; --info:#52d6ca;
  --focus:#a6c4ff; --radius:14px; --space:16px; --shadow: 0 10px 40px rgba(0,0,0,.35);
  --ring: 0 0 0 3px var(--focus);
  --grid: 1160px;
  --glass: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.04));
}

/* ====== RESET ====== */
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background: radial-gradient(1200px 800px at 10% -10%, #2a3cff22, transparent 60%),
             radial-gradient(1000px 700px at 110% 20%, #00ffd222, transparent 60%),
             var(--bg); color:var(--ink); font: 15px/1.6 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;}
a{color:inherit}

/* ====== FLOATING ORBS (wow) ====== */
.bg-orb{position:fixed; filter: blur(60px); opacity:.7; z-index:0; pointer-events:none; mix-blend-mode:screen}
.bg-orb.one{width:420px;height:420px;left:-140px;top:-80px;background:#6d8cff44;border-radius:50%;
  animation: float1 18s ease-in-out infinite;}
.bg-orb.two{width:520px;height:520px;right:-160px;bottom:-120px;background:#52d6ca33;border-radius:50%;
  animation: float2 22s ease-in-out infinite;}
@keyframes float1{50%{transform: translate(40px,30px) scale(1.05)}}
@keyframes float2{50%{transform: translate(-30px,-40px) scale(1.08)}}

/* ====== LAYOUT ====== */
.layout{position:relative; z-index:1; display:grid; grid-template-columns: 300px 1fr; min-height:100vh;}
aside.sidebar{
  position:sticky; top:0; height:100vh; padding:18px; backdrop-filter: blur(14px);
  background: var(--panel); border-right:1px solid rgba(255,255,255,.1);
  display:flex; flex-direction:column; gap:14px;
}
.brand{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;background:var(--glass);box-shadow:var(--shadow)}
.brand .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#7aa2ff,#52d6ca)}
.brand h1{font-size:18px; margin:0}
.mockchip{margin-left:auto; font-size:12px; padding:4px 8px;border-radius:999px; background:#ffb74d22; border:1px solid #ffb74d66}

.nav ul{list-style:none;margin:0;padding:0;display:grid;gap:6px}
.nav a{
  display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;text-decoration:none;
  background: transparent; border:1px solid transparent; transition:.2s transform;
}
.nav a:hover{background: rgba(255,255,255,.06); transform: translateY(-1px)}
.nav a[aria-current="page"]{ background: rgba(255,255,255,.12); border-color: rgba(255,255,255,.14); }
.nav svg{opacity:.85}

.sidebar-foot{margin-top:auto;color:var(--muted);font-size:12px;display:flex;justify-content:space-between;align-items:center}
.kbd{font: 11px/1.2 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; padding:3px 6px; border-radius:6px; background:#0008; border:1px solid #fff2}

main.content{padding:26px; max-width: 1400px}

.section-head{display:flex;justify-content:space-between;align-items:center;margin: 10px 0 16px}
.section-head h2{margin:0;font-size:22px}
.actions{display:flex;gap:10px;flex-wrap:wrap}

/* ====== CARDS ====== */
.cards{display:grid;grid-template-columns: repeat(auto-fill, minmax(280px,1fr)); gap:16px}
.card{background:var(--glass); border:1px solid rgba(255,255,255,.14); border-radius:14px; padding:14px; box-shadow: var(--shadow);
  transform: translateZ(0); transition: transform .2s ease, box-shadow .2s ease;}
.card:hover{transform: translateY(-4px); box-shadow: 0 16px 60px rgba(0,0,0,.45)}
.card h3{margin:2px 0 4px; font-size:16px}
.card p{margin:0 0 12px; color:var(--muted)}
.row{display:flex; gap:8px; flex-wrap:wrap}
.tag{font-size:12px; padding:2px 8px; border-radius:999px; background:#ffffff18; border:1px solid #ffffff33}

/* ====== FORMS ====== */
label{display:block;margin: 12px 0 6px}
input, textarea, select{
  width:100%; background: #0a0f22; color: var(--ink);
  border:1px solid rgba(255,255,255,.18); border-radius: 12px; padding: 12px 12px;
}
small.hint{color:var(--muted)}
input:focus-visible, textarea:focus-visible, select:focus-visible{ outline: none; box-shadow: var(--ring) }

.btn{display:inline-flex;align-items:center;gap:8px; border:1px solid rgba(255,255,255,.2); color:var(--ink);
  background: #101632; padding:10px 14px; border-radius: 12px; cursor:pointer; text-decoration:none; transition:.2s transform}
.btn:hover{transform: translateY(-1px); background:#0f152e}
.btn.primary{ background: linear-gradient(135deg, var(--pri), #52d6ca); color: #081022; border: none; }
.btn.ghost{ background: transparent }
.btn:focus-visible{ outline: none; box-shadow: var(--ring) }

/* ====== PREVIEW ====== */
.preview{margin-top:16px}
.preview iframe{width:100%; height:520px; background:white; border:1px solid rgba(255,255,255,.2); border-radius:12px}

/* ====== ALERTS / TOASTS ====== */
.alert{margin-top:12px; padding:10px 12px; border-radius:12px; border:1px solid; background:#0005}
.alert.info{border-color:#2b9; background:#1a3c39}
.alert.err{border-color:#b24; background:#381b26}
.toast{position:fixed; right:18px; bottom:18px; background:#121b36; border:1px solid #2b3b77; padding:12px 14px; border-radius:12px; box-shadow:var(--shadow); z-index:99}

/* ====== ROUTES ====== */
.route[hidden]{display:none}

/* ====== MISC ====== */
.skip{position:absolute;left:-9999px}
.skip:focus{left:auto;top:auto; background:#fff;color:#111;padding:8px;border-radius:8px}

/* ====== RESPONSIVE ====== */
@media (max-width: 980px){
  .layout{grid-template-columns: 1fr}
  aside.sidebar{position:sticky;height:auto}
}
</style>
</head>
<body>
<div class="bg-orb one"></div>
<div class="bg-orb two"></div>

<a class="skip" href="#main">Saltar al contenido</a>

<div class="layout">
  <aside class="sidebar" aria-label="Barra lateral">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <h1>Project Central</h1>
      <span class="mockchip" title="Modo local/offline">Mock mode</span>
    </div>
    <nav class="nav" aria-label="Navegación principal">
      <ul role="list">
        <li><a href="#/dashboard" aria-current="page">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M3 12l9-9 9 9v8a2 2 0 0 1-2 2h-4v-8H9v8H5a2 2 0 0 1-2-2v-8z"/></svg>
          Dashboard</a></li>
        <li><a href="#/new"><svg width="18" height="18" viewBox="0 0 24 24"><path d="M12 5v14m-7-7h14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>New Project</a></li>
        <li><a href="#/profile"><svg width="18" height="18" viewBox="0 0 24 24"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-6 0-9 3-9 6v1h18v-1c0-3-3-6-9-6z" fill="currentColor"/></svg>Profile</a></li>
        <li><a href="#/faq"><svg width="18" height="18" viewBox="0 0 24 24"><path d="M12 18h.01M8 9a4 4 0 1 1 8 0c0 3-4 3-4 6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>FAQ</a></li>
        <li><a href="#/settings"><svg width="18" height="18" viewBox="0 0 24 24"><path d="M12 8a4 4 0 1 1 0 8 4 4 0 0 1 0-8zm8.94 4a7.94 7.94 0 0 0-.15-1.6l2.12-1.65-2-3.46-2.56 1a8.16 8.16 0 0 0-2.77-1.6L13.9 1h-3.8l-.68 2.7a8.16 8.16 0 0 0-2.77 1.6l-2.56-1-2 3.46 2.12 1.65a7.94 7.94 0 0 0 0 3.2L2.1 15.25l2 3.46 2.56-1a8.16 8.16 0 0 0 2.77 1.6l.68 2.7h3.8l.68-2.7a8.16 8.16 0 0 0 2.77-1.6l2.56 1 2-3.46-2.12-1.65c.09-.52.15-1.05.15-1.6z" fill="currentColor"/></svg>Settings</a></li>
        <li><a href="#/support"><svg width="18" height="18" viewBox="0 0 24 24"><path d="M3 8a9 9 0 1 1 18 0v8a2 2 0 0 1-2 2h-5l-4 4v-4H5a2 2 0 0 1-2-2z" fill="currentColor"/></svg>Support</a></li>
      </ul>
    </nav>
    <div class="sidebar-foot">
      <span>v1.0</span>
      <span class="kbd">⌘K</span>
    </div>
  </aside>

  <main id="main" class="content" tabindex="-1">
    <!-- DASHBOARD -->
    <section data-route="dashboard" class="route">
      <header class="section-head">
        <h2>Proyectos</h2>
        <div class="actions">
          <a class="btn primary" href="#/new">+ Nuevo proyecto</a>
          <button class="btn ghost" id="palette-btn" title="Cmd/Ctrl + K">Command Palette</button>
        </div>
      </header>
      <div id="projects-empty" class="alert info" role="status" aria-live="polite" hidden>
        Aún no hay proyectos. Crea el primero con “+ Nuevo proyecto”.
      </div>
      <ul id="projects-list" class="cards" role="list" aria-live="polite"></ul>
    </section>

    <!-- NEW -->
    <section data-route="new" class="route" hidden>
      <header class="section-head">
        <h2>Nuevo proyecto</h2>
        <div class="actions">
          <a class="btn" href="#/dashboard">Volver</a>
        </div>
      </header>
      <form id="new-form" novalidate>
        <label for="prompt">Prompt del sitio</label>
        <textarea id="prompt" rows="7" required placeholder="Ej.: Landing premium para estudio creativo: hero con claim, grid de proyectos, testimonios y CTA a contacto. Animación sutil on-scroll."></textarea>
        <small id="prompt-hint" class="hint">Describe estructura, tono, secciones, estilo y microinteracciones.</small>

        <label for="name">Nombre del proyecto</label>
        <input id="name" required placeholder="creative-studio" />

        <label for="desc">Descripción</label>
        <input id="desc" placeholder="Landing para estudio con portfolio y formulario" />

        <div class="row" style="margin-top:10px">
          <label><input type="checkbox" id="use-ai" checked disabled> Usar IA (requiere Functions)</label>
          <label><input type="checkbox" id="use-template"> Usar template base</label>
          <label><input type="checkbox" id="private-repo" checked> Repo privado (cuando conectes)</label>
        </div>

        <div class="actions" style="margin-top:14px">
          <button class="btn primary" type="submit">Generar</button>
          <button class="btn" type="button" id="preview-btn">Previsualizar</button>
        </div>

        <div id="form-errors" class="alert err" role="alert" hidden></div>
        <div id="form-info" class="alert info" role="status" hidden></div>
      </form>

      <div id="local-preview" class="preview" hidden>
        <header><h3>Preview</h3></header>
        <iframe id="preview" title="Previsualización del sitio" sandbox=""></iframe>
      </div>
    </section>


<!-- PROFILE -->
<section data-route="profile" class="route" hidden>
  <h2>Perfil</h2>
  <p>Modo pruebas (owner único). Más adelante: inicio de sesión y permisos por rol.</p>
  <div class="alert info" id="conn-info">Cuando despliegues en Netlify, esta sección mostrará conexiones y cuotas de API.</div>
  <div class="cards" id="conn-cards" style="margin-top:12px"></div>
  <script>
    (function(){
      const st = JSON.parse(localStorage.getItem('pcentral-settings')||'{}');
      const items = [
        {name:'GitHub', ok: !!st.ghTokenMasked},
        {name:'Netlify', ok: !!st.netlifyTokenMasked},
        {name:'OpenAI API', ok: !!st.openaiKeyMasked},
        {name:'Assistant ID', ok: !!st.openaiAsst}
      ];
      const wrap = document.getElementById('conn-cards');
      wrap.innerHTML = items.map(i => \`
        <div class="card"><h3>\${i.name}</h3>
        <p>\${i.ok ? 'Configurado' : 'Sin configurar'}</p>
        </div>\`).join('');
    })();
  </script>
</section>

<section data-route="faq" class="route" hidden>
 class="route" hidden>
      <h2>FAQ</h2>
      <details><summary>¿Cómo descargo el ZIP?</summary><p>En cada tarjeta de proyecto, usa “Descargar ZIP”. Se genera **localmente** (sin librerías).</p></details>
      <details><summary>¿Cómo exporto a Figma?</summary><p>Usa “Exportar Figma (JSON)” para copiar/descargar un JSON compatible con el plugin de importación.</p></details>
      <details><summary>¿Se conecta a GitHub/Netlify?</summary><p>En **Mock mode** no. Cuando la subas a Netlify, apunta tus Functions a las APIs de GitHub/Netlify y listo.</p></details>
    </section>


<!-- SETTINGS -->
<section data-route="settings" class="route" hidden>
  <h2>Settings</h2>
  <p>Preferencias locales (guardadas en tu navegador). Los tokens se almacenan <strong>solo en este navegador</strong>. No se envían a ningún servidor en Mock mode.</p>

  <label for="color-accent">Acento</label>
  <select id="color-accent">
    <option value="#7aa2ff">Azul</option>
    <option value="#52d6ca">Turquesa</option>
    <option value="#ff7ab6">Magenta</option>
    <option value="#ffd166">Ámbar</option>
  </select>

  <h3 style="margin-top:18px">APIs</h3>
  <small class="hint">Introduce tus credenciales para habilitar integraciones cuando despliegues con Functions.</small>

  <label for="gh-token">GitHub Token</label>
  <input id="gh-token" type="password" placeholder="github_pat_... o ghp_..." autocomplete="off" />

  <label for="netlify-token">Netlify Token</label>
  <input id="netlify-token" type="password" placeholder="token personal de Netlify" autocomplete="off" />

  <div class="row" style="gap:12px">
    <div style="flex:1">
      <label for="openai-key">OpenAI API Key</label>
      <input id="openai-key" type="password" placeholder="sk-...." autocomplete="off" />
    </div>
    <div style="flex:1">
      <label for="openai-asst">OpenAI Assistant ID</label>
      <input id="openai-asst" type="text" placeholder="asst_..." autocomplete="off" />
    </div>
  </div>

  <div class="actions" style="margin-top:12px">
    <button class="btn" id="toggle-visibility" type="button">Mostrar</button>
    <button class="btn primary" id="save-settings" type="button">Guardar</button>
  </div>

  <div id="settings-info" class="alert info" role="status" hidden></div>
  <div id="settings-errors" class="alert err" role="alert" hidden></div>
</section>

<!-- SUPPORT -->

    <section data-route="support" class="route" hidden>
      <h2>Soporte</h2>
      <p>¿Dudas o ideas? Escríbelas aquí (solo local).</p>
      <label for="feedback">Mensaje</label>
      <textarea id="feedback" rows="5" placeholder="Ideas de mejora, bugs, etc."></textarea>
      <button class="btn" id="send-feedback" style="margin-top:10px">Enviar</button>
      <div id="support-toast" class="toast" role="status" aria-live="polite" hidden>¡Gracias por tu feedback!</div>
    </section>
  </main>
</div>

<!-- Command Palette -->
<dialog id="palette" aria-label="Command palette">
  <form method="dialog" style="margin:0">
    <div style="padding:14px;background:#0c1330;border:1px solid #2b3b77;border-radius:14px;min-width:520px;max-width:90vw">
      <input id="pal-input" placeholder="Escribe un comando (new, preview, settings…)" autofocus>
      <div id="pal-list" class="cards" style="margin-top:10px"></div>
      <div style="margin-top:10px;display:flex;justify-content:flex-end;gap:8px">
        <button class="btn">Cerrar</button>
      </div>
    </div>
  </form>
</dialog>

<!-- Live region for a11y -->
<div id="live" class="skip" role="status" aria-live="polite"></div>

<script>
/* ========================
   STATE (IndexedDB-lite via localStorage)
   ======================== */
const LS_KEY = 'pcentral-projects';
const settingsKey = 'pcentral-settings';

const $ = sel => document.querySelector(sel);
const routeEls = () => document.querySelectorAll('.route');

function loadProjects(){
  try { return JSON.parse(localStorage.getItem(LS_KEY)) || []; } catch { return []; }
}
function saveProjects(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }
function upsertProject(p){
  const list = loadProjects();
  const i = list.findIndex(x => x.id === p.id);
  if(i>=0) list[i] = p; else list.unshift(p);
  saveProjects(list);
}
function uuid(){ return 'p-' + Math.random().toString(36).slice(2,8) + '-' + Date.now().toString(36); }
function slugify(s){ return (s||'').toLowerCase().replace(/[^a-z0-9-]+/g,'-').replace(/^-+|-+$/g,'').slice(0,60) || 'site'; }

/* ========================
   ZIP (STORE, no compresión) — sin librerías externas
   ======================== */
const CRC_TABLE = (()=>{let c,table=[];for(let n=0;n<256;n++){c=n;for(let k=0;k<8;k++){c=c&1?0xedb88320^(c>>>1):c>>>1}table[n]=c>>>0}return table})();
function crc32Uint8(arr){let c=0xffffffff;for(let i=0;i<arr.length;i++){c=CRC_TABLE[(c^arr[i])&0xff]^(c>>>8)}return (c^0xffffffff)>>>0}
function strToU8(str){return new TextEncoder().encode(str)}
function dosTimeDate(d=new Date()){
  const time = ((d.getHours()&0x1f)<<11)|((d.getMinutes()&0x3f)<<5)|((Math.floor(d.getSeconds()/2))&0x1f);
  const date = (((d.getFullYear()-1980)&0x7f)<<9)|(((d.getMonth()+1)&0xf)<<5)|((d.getDate())&0x1f);
  return {time, date}
}
function writeU16(view, off, v){view.setUint16(off, v, true);return off+2}
function writeU32(view, off, v){view.setUint32(off, v, true);return off+4}
function makeZip(filesObj){
  // filesObj: { "path/filename": "content-string", ... }
  const names = Object.keys(filesObj);
  const fileRecords = [];
  let localSize = 0;
  // First pass: build local file headers + data
  const chunks = [];
  for(const name of names){
    const nameU8 = strToU8(name);
    const dataU8 = strToU8(filesObj[name]);
    const crc = crc32Uint8(dataU8);
    const {time,date} = dosTimeDate(new Date());
    const LOCAL_SIG = 0x04034b50;
    const need = 30 + nameU8.length + dataU8.length;
    const buf = new ArrayBuffer(need);
    const view = new DataView(buf);
    let off=0;
    off = writeU32(view, off, LOCAL_SIG);
    off = writeU16(view, off, 20); // version needed
    off = writeU16(view, off, 0);  // flags
    off = writeU16(view, off, 0);  // method 0=store
    off = writeU16(view, off, time);
    off = writeU16(view, off, date);
    off = writeU32(view, off, crc);
    off = writeU32(view, off, dataU8.length);
    off = writeU32(view, off, dataU8.length);
    off = writeU16(view, off, nameU8.length);
    off = writeU16(view, off, 0); // extra len
    new Uint8Array(buf, off, nameU8.length).set(nameU8); off += nameU8.length;
    new Uint8Array(buf, off, dataU8.length).set(dataU8); off += dataU8.length;

    chunks.push(new Uint8Array(buf));
    fileRecords.push({
      nameU8, crc, size: dataU8.length, compSize: dataU8.length,
      time, date, localHeaderOffset: localSize
    });
    localSize += need;
  }

  // Central directory
  const CENTRAL_SIG = 0x02014b50;
  const END_SIG = 0x06054b50;
  let centralSize = 0;
  const centralChunks = [];
  for(const rec of fileRecords){
    const need = 46 + rec.nameU8.length;
    const buf = new ArrayBuffer(need);
    const view = new DataView(buf); let off=0;
    off = writeU32(view, off, CENTRAL_SIG);
    off = writeU16(view, off, 20); // version made by
    off = writeU16(view, off, 20); // version needed
    off = writeU16(view, off, 0);  // flags
    off = writeU16(view, off, 0);  // method
    off = writeU16(view, off, rec.time);
    off = writeU16(view, off, rec.date);
    off = writeU32(view, off, rec.crc);
    off = writeU32(view, off, rec.compSize);
    off = writeU32(view, off, rec.size);
    off = writeU16(view, off, rec.nameU8.length);
    off = writeU16(view, off, 0); // extra
    off = writeU16(view, off, 0); // comment
    off = writeU16(view, off, 0); // disk start
    off = writeU16(view, off, 0); // internal attrs
    off = writeU32(view, off, 0); // external attrs
    off = writeU32(view, off, rec.localHeaderOffset);
    new Uint8Array(buf, off, rec.nameU8.length).set(rec.nameU8); off += rec.nameU8.length;

    centralChunks.push(new Uint8Array(buf));
    centralSize += need;
  }

  // End of central directory
  const endBuf = new ArrayBuffer(22);
  const endView = new DataView(endBuf); let off=0;
  off = writeU32(endView, off, END_SIG);
  off = writeU16(endView, off, 0); // disk
  off = writeU16(endView, off, 0); // disk start
  off = writeU16(endView, off, fileRecords.length);
  off = writeU16(endView, off, fileRecords.length);
  off = writeU32(endView, off, centralSize);
  off = writeU32(endView, off, localSize);
  off = writeU16(endView, off, 0); // comment len

  // Concat all
  const totalLen = localSize + centralSize + 22;
  const out = new Uint8Array(totalLen);
  let pos = 0;
  for(const c of chunks){ out.set(c, pos); pos += c.length; }
  for(const c of centralChunks){ out.set(c, pos); pos += c.length; }
  out.set(new Uint8Array(endBuf), pos);

  return new Blob([out], { type: 'application/zip' });
}

/* ========================
   GENERATOR (determinista local)
   ======================== */
function generateSite({name, prompt}){
  const hasGallery = /galer[ií]a|gallery/i.test(prompt);
  const hasForm = /contacto|formulario|contact/i.test(prompt);
  const dark = /oscuro|dark/i.test(prompt);
  const accent = getAccent();

  const css = `
  :root{--ink:${dark?'#f2f4ff':'#111'};--bg:${dark?'#0b0f1c':'#fff'};--pri:${accent}}
  *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.65 system-ui}
  a{color:inherit}
  header{padding:80px 24px;background:linear-gradient(135deg,var(--pri),${dark?'#141a33':'#111'});color:#fff}
  .wrap{max-width:1120px;margin:0 auto;padding:24px}
  header h1{margin:0 0 8px;font-size:48px}
  section{padding:48px 0;border-bottom:1px solid ${dark?'#1b2344':'#eee'}}
  .grid{display:grid;grid-template-columns: repeat(auto-fit,minmax(240px,1fr));gap:18px}
  .card{border:1px solid ${dark?'#233055':'#eee'};border-radius:12px;padding:14px}
  button,.btn{display:inline-block;padding:12px 16px;background:var(--pri);color:#081022;border:none;border-radius:10px;text-decoration:none}
  input,textarea{width:100%;padding:10px;border:1px solid ${dark?'#233055':'#ddd'};border-radius:10px;background:${dark?'#0e1428':'#fff'};color:var(--ink)}
  footer{padding:24px 0;color:${dark?'#aeb4d6':'#555'}}`;

  let body = `
  <header role="banner"><div class="wrap">
    <h1>${escapeHtml(name)}</h1>
    <p>${escapeHtml(prompt).slice(0,160)}...</p>
    <a class="btn" href="#contacto">Empezar</a>
  </div></header>
  <main role="main"><div class="wrap">
    <section aria-labelledby="beneficios"><h2 id="beneficios">Beneficios</h2>
      <div class="grid">
        <article class="card"><h3>Velocidad</h3><p>Carga rápida y fluida.</p></article>
        <article class="card"><h3>Accesibilidad</h3><p>Semántica y foco visible.</p></article>
        <article class="card"><h3>Escalabilidad</h3><p>Estructura modular.</p></article>
      </div>
    </section>`;

  if(hasGallery){
    body += `
    <section aria-labelledby="galeria"><h2 id="galeria">Galería</h2>
      <div class="grid">
        <img alt="Muestra 1" src="https://picsum.photos/seed/1/800/520">
        <img alt="Muestra 2" src="https://picsum.photos/seed/2/800/520">
        <img alt="Muestra 3" src="https://picsum.photos/seed/3/800/520">
      </div>
    </section>`;
  }

  if(hasForm){
    body += `
    <section id="contacto" aria-labelledby="contacto-title"><h2 id="contacto-title">Contacto</h2>
      <form>
        <label for="email">Email</label>
        <input id="email" type="email" required>
        <label for="msg">Mensaje</label>
        <textarea id="msg" rows="5"></textarea>
        <button type="submit">Enviar</button>
      </form>
    </section>`;
  }

  body += `</div></main><footer role="contentinfo"><div class="wrap">© ${new Date().getFullYear()} ${escapeHtml(name)}</div></footer>`;

  return {
    files: {
      'index.html': `<!doctype html><html lang="es"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>${escapeHtml(name)}</title><style>${css}</style></head><body>${body}</body></html>`,
      'styles/style.css': '/* Añade tus estilos aquí */',
      'scripts/app.js': '/* JS para interacciones personalizadas */'
    }
  };
}

function escapeHtml(s=''){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function getAccent(){ return (JSON.parse(localStorage.getItem(settingsKey)||'{}').accent) || '#7aa2ff'; }

/* ========================
   UI / ROUTER
   ======================== */
const routes = ['dashboard','new','profile','faq','settings','support'];
window.addEventListener('hashchange', renderRoute);
window.addEventListener('DOMContentLoaded', () => {
  renderRoute();
  loadSettingsIntoUI();
  renderProjects();
  wireNewForm();
  wirePalette();
  wireSupport();
  bindShortcuts();
});

function renderRoute(){
  const route = location.hash.replace('#/','') || 'dashboard';
  routeEls().forEach(sec => sec.hidden = true);
  const found = routes.includes(route) ? route : 'dashboard';
  document.querySelector(`[data-route="${found}"]`).hidden = false;
  document.querySelectorAll('.nav a').forEach(a => a.setAttribute('aria-current', a.getAttribute('href') === `#/${found}` ? 'page' : 'false'));
  $('#main').focus();
}

function renderProjects(){
  const list = loadProjects();
  const ul = $('#projects-list'); ul.innerHTML = '';
  $('#projects-empty').hidden = list.length>0;
  for(const p of list){
    const li = document.createElement('li'); li.className='card'; li.innerHTML = `
      <h3>${p.name}</h3>
      <p>${p.desc||''}</p>
      <div class="row" style="margin-bottom:8px">
        <span class="tag">${p.status||'local'}</span>
        ${p.netlifyUrl?`<span class="tag">deployed</span>`:''}
      </div>
      <div class="row">
        <button class="btn" data-act="view" data-id="${p.id}">Ver sitio</button>
        <button class="btn" data-act="zip" data-id="${p.id}">Descargar ZIP</button>
        <button class="btn" data-act="figma" data-id="${p.id}">Exportar Figma (JSON)</button>
        <button class="btn ghost" data-act="deploy" data-id="${p.id}">Simular deploy</button>
      </div>`;
    ul.appendChild(li);
  }
  ul.onclick = async (e) => {
    const btn = e.target.closest('button[data-act]'); if(!btn) return;
    const id = btn.dataset.id;
    const proj = loadProjects().find(x=>x.id===id); if(!proj) return;
    if(btn.dataset.act==='view'){
      openPreview(proj);
    }
    if(btn.dataset.act==='zip'){
      const blob = makeZip(proj.files);
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${proj.name}.zip`;
      a.click(); URL.revokeObjectURL(a.href);
      live('ZIP generado');
    }
    if(btn.dataset.act==='figma'){
      const json = buildFigmaJSON(proj);
      try {
        await navigator.clipboard.writeText(JSON.stringify(json, null, 2));
        alert('JSON copiado. Abre tu plugin de Figma y pégalo.');
      } catch {
        const blob = new Blob([JSON.stringify(json, null, 2)], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `${proj.name}-figma.json`; a.click(); URL.revokeObjectURL(a.href);
      }
    }
    if(btn.dataset.act==='deploy'){
      const list = loadProjects();
      const i = list.findIndex(x=>x.id===id);
      list[i].netlifyUrl = list[i].netlifyUrl || `https://${list[i].slug}.netlify.app`;
      list[i].status = 'deployed (sim)';
      saveProjects(list); renderProjects();
      live('Deploy simulado (URL generada)');
    }
  };
}

function openPreview(proj){
  location.hash = '#/new';
  const iframe = $('#preview');
  iframe.src = URL.createObjectURL(new Blob([proj.files['index.html']||'<h1>Sin index.html</h1>'], {type:'text/html'}));
  $('#local-preview').hidden = false;
  $('#form-info').hidden = false; $('#form-info').textContent = 'Preview cargado desde el proyecto guardado.';
}

function wireNewForm(){
  const form = $('#new-form');
  const errors = $('#form-errors');
  const info = $('#form-info');
  $('#preview-btn').onclick = () => {
    const prompt = $('#prompt').value.trim();
    const name = $('#name').value.trim() || 'proyecto';
    if(!prompt){ showError('El prompt es requerido.'); return; }
    const gen = generateSite({name, prompt});
    const url = URL.createObjectURL(new Blob([gen.files['index.html']],{type:'text/html'}));
    const iframe = $('#preview'); iframe.src = url;
    $('#local-preview').hidden = false;
    info.hidden = false; info.textContent = 'Preview local generado.';
    errors.hidden = true;
  };
  form.onsubmit = async (e)=>{
  e.preventDefault();
  const prompt = $('#prompt').value.trim();
  const name = $('#name').value.trim();
  const desc = $('#desc').value.trim();
  if(!prompt || !name){ showError('Prompt y Nombre son obligatorios.'); return; }
  const slug = slugify(name);
  const id = uuid();



  // Try backend Assistant (Netlify Function). Fallback to local generator if fails.
  try{
    const r = await fetch('/.netlify/functions/generate', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ prompt, name })
    });
    const data = await r.json();
    if(!r.ok) throw new Error(data.error || 'Error de generación');
    upsertProject({ id, name, slug, desc, status:'generated', files:data.files, createdAt:Date.now() });
    live('Proyecto generado por Assistant');
  } catch(err){
    console.warn('Assistant falló, usando generador local:', err);
    const gen = generateSite({name, prompt});
    upsertProject({ id, name, slug, desc, status:'local', files:gen.files, createdAt:Date.now() });
    live('Proyecto creado localmente');
  }
  location.hash = '#/dashboard';
  renderProjects();
};
  function showError(msg){
    errors.hidden = false; errors.textContent = msg;
    info.hidden = true; $('#prompt').focus();
  }
}

function wireSupport(){
  $('#send-feedback').onclick = ()=>{
    $('#support-toast').hidden = false;
    setTimeout(()=> $('#support-toast').hidden = true, 1600);
  };
}

/* ========================
   Figma JSON (simple)
   ======================== */
function buildFigmaJSON(proj){
  return {
    version:1,
    meta:{ name: proj.name, slug: proj.slug, exportedAt: Date.now() },
    document:{
      frames:[
        { type:'frame', name:'Hero', width:1440, height:600, fill:'#1b2a4d',
          children:[
            { type:'text', x:80, y:120, content: proj.name, size:64, color:'#fff' },
            { type:'text', x:80, y:200, content: 'Generado desde Project Central', size:24, color:'#e5e7eb' }
          ]
        },
        { type:'frame', name:'Contenido', width:1440, height:1000, fill:'#ffffff',
          children:[ { type:'text', x:80, y:80, content:'Secciones base + estilos', size:32, color:'#111' } ]
        }
      ]
    }
  };
}

/* ========================
   Settings
   ======================== */
function loadSettingsIntoUI(){
  const st = JSON.parse(localStorage.getItem(settingsKey) || '{}');
  if(st.accent) $('#color-accent').value = st.accent;
  $('#save-settings').onclick = ()=>{
    const accent = $('#color-accent').value;
    localStorage.setItem(settingsKey, JSON.stringify({accent}));
    document.documentElement.style.setProperty('--pri', accent);
    live('Preferencias guardadas');
  };
  if(st.accent) document.documentElement.style.setProperty('--pri', st.accent);
}

/* ========================
   Command Palette + Shortcuts
   ======================== */
function wirePalette(){
  const dlg = $('#palette'); const list = $('#pal-list'); const input = $('#pal-input');
  const cmds = [
    {id:'new', label:'Nuevo proyecto', action: ()=> location.hash='#/new'},
    {id:'dash', label:'Ir a Dashboard', action: ()=> location.hash='#/dashboard'},
    {id:'settings', label:'Abrir Settings', action: ()=> location.hash='#/settings'},
    {id:'faq', label:'Abrir FAQ', action: ()=> location.hash='#/faq'},
    {id:'theme', label:'Cambiar acento (cíclico)', action: cycleAccent}
  ];
  function render(items){
    list.innerHTML = ''; items.forEach(c=>{
      const div = document.createElement('div'); div.className='card'; div.style.cursor='pointer';
      div.textContent = c.label; div.onclick = ()=>{ dlg.close(); c.action(); };
      list.appendChild(div);
    });
  }
  render(cmds);
  $('#palette-btn').onclick = ()=> { dlg.showModal(); input.focus(); input.select(); };
  input.oninput = ()=> {
    const q = input.value.trim().toLowerCase();
    const filtered = cmds.filter(c=> c.label.toLowerCase().includes(q) || c.id.includes(q));
    render(filtered.length?filtered:cmds);
  };
}
function bindShortcuts(){
  window.addEventListener('keydown', (e)=>{
    if((e.metaKey||e.ctrlKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); $('#palette-btn').click(); }
    if((e.metaKey||e.ctrlKey) && e.key.toLowerCase()==='n'){ e.preventDefault(); location.hash='#/new'; $('#prompt').focus(); }
  });
}
function cycleAccent(){
  const options = ['#7aa2ff', '#52d6ca', '#ff7ab6', '#ffd166'];
  const cur = getAccent(); const idx = options.indexOf(cur);
  const next = options[(idx+1)%options.length];
  localStorage.setItem(settingsKey, JSON.stringify({accent: next}));
  document.documentElement.style.setProperty('--pri', next);
}

/* ========================
   A11y live helper
   ======================== */
function live(msg){ const el = $('#live'); el.textContent=''; setTimeout(()=> el.textContent = msg, 50); }
</script>
</body>
</html>
