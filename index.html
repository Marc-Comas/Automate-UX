<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Project Central ‚Äî Cloud Mode (GitHub Data)</title>
<style>
:root{--bg:#0b0f1c;--panel:#ffffff10;--ink:#eef1ff;--pri:#7aa2ff;--danger:#ff6d8c}
*{box-sizing:border-box}body{margin:0;background:linear-gradient(180deg,#0b0f1c,#0d142c);color:var(--ink);font:15px/1.6 system-ui}
.layout{display:grid;grid-template-columns:280px 1fr;min-height:100vh}
aside{padding:18px;background:var(--panel);backdrop-filter: blur(10px);border-right:1px solid #ffffff22}
main{padding:26px}
.nav a{display:block;padding:10px 12px;margin:6px 0;border-radius:10px;color:inherit;text-decoration:none}
.nav a[aria-current="page"]{background:#ffffff18;border:1px solid #ffffff33}
.btn{display:inline-flex;gap:8px;align-items:center;padding:9px 12px;border-radius:10px;background:#101632;border:1px solid #ffffff22;color:var(--ink);cursor:pointer}
.btn.primary{background:linear-gradient(135deg,#7aa2ff,#52d6ca);color:#081022;border:none}
.cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;margin-top:12px}
.card{position:relative;background:var(--panel);border:1px solid #ffffff22;border-radius:14px;padding:14px}
label{display:block;margin:10px 0 6px}
input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid #ffffff33;background:#0a1026;color:var(--ink)}
.alert{margin-top:12px;padding:10px;border-radius:10px;border:1px solid #2b9;background:#173b3a}
.alert.err{border-color:#b24;background:#381b26}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.tag{font-size:12px;padding:2px 8px;border-radius:999px;background:#ffffff18;border:1px solid #ffffff33}
.preview iframe,.preview-iframe{width:100%;height:60vh;background:white;border-radius:10px;border:1px solid #ffffff22}
.menu-wrap{position:absolute; right:10px; top:10px}
.menu-btn{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:8px;border:1px solid #ffffff33;background:#0a1026;cursor:pointer}
.menu{position:absolute; right:0; margin-top:6px; min-width:200px; background:#0b1028; border:1px solid #2b3b77; border-radius:12px; padding:6px; box-shadow:0 10px 30px rgba(0,0,0,.35); display:none; z-index:10}
.menu[aria-hidden="false"]{display:block}
.menu button{width:100%; text-align:left; padding:8px 10px; border:none; background:transparent; color:var(--ink); border-radius:8px; cursor:pointer}
.menu button:hover{background:#ffffff12}
.menu .danger{color:var(--danger)}
.kbd{font: 11px/1.2 ui-monosace, SFMono-Regular, Menlo, Consolas, monospace; padding:3px 6px; border-radius:6px; background:#0008; border:1px solid #fff2}
@media (max-width:980px){.layout{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="layout">
  <aside>
    <h2 style="margin:0 0 8px">Project Central</h2>
    <nav class="nav">
      <a href="#/dashboard" aria-current="page">Dashboard</a>
      <a href="#/new">New Project</a>
      <a href="#/settings">Settings</a>
      <a href="#/profile">Profile</a>
    </nav>
  </aside>
  <main id="main" tabindex="-1">
    <!-- DASHBOARD -->
    <section data-route="dashboard" class="route">
      <header class="row" style="justify-content:space-between">
        <h2 style="margin:0">Proyectos</h2>
        <div class="row"><a class="btn primary" href="#/new">+ Nuevo proyecto</a></div>
      </header>
      <div id="projects-empty" class="alert" hidden>A√∫n no hay proyectos.</div>
      <ul id="projects-list" class="cards" role="list" aria-live="polite"></ul>
    </section>

    <!-- NEW -->
    <section data-route="new" class="route" hidden>
      <h2>Nuevo proyecto</h2>
      <form id="new-form" novalidate>
        <label for="prompt">Prompt del sitio</label>
        <textarea id="prompt" rows="6" required placeholder="Brief de la landing (secciones, estilo, etc.)"></textarea>
        <label for="name">Nombre del proyecto</label>
        <input id="name" required placeholder="creative-studio">
        <label for="desc">Descripci√≥n</label><input id="desc" placeholder="Landing para estudio...">
        <div class="row" style="margin-top:10px">
          <button class="btn primary" type="submit">Generar</button>
          <button class="btn" type="button" id="preview-btn">Previsualizar</button>
        </div>
        <div id="form-errors" class="alert err" hidden></div>
        <div id="form-info" class="alert" hidden></div>
      </form>
      <div id="local-preview" class="preview" hidden>
        <h3>Preview</h3>
        <iframe id="preview" title="Previsualizaci√≥n"></iframe>
      </div>
    </section>

    <!-- PREVIEW -->
    <section data-route="preview" class="route" hidden>
      <header class="row" style="justify-content:space-between">
        <h2 id="pv-title" style="margin:0">Preview</h2>
        <div class="row">
          <a class="btn" href="#/dashboard">Volver</a>
          <button class="btn" id="pv-download">Descargar ZIP</button>
        </div>
      </header>
      <div class="preview">
        <iframe id="pv-iframe" class="preview-iframe" title="Vista previa del sitio"></iframe>
      </div>
      <div style="margin-top:12px">
        <label for="pv-prompt">Modificar con prompt</label>
        <textarea id="pv-prompt" rows="5" placeholder="Ej.: Oscurece el tema y a√±ade secci√≥n de precios con 3 planes"></textarea>
        <div class="row" style="margin-top:8px">
          <button class="btn primary" id="pv-apply-ai">Aplicar cambios (IA)</button>
          <button class="btn" id="pv-apply-local">Aplicar cambios (local)</button>
        </div>
        <div id="pv-info" class="alert" hidden></div>
        <div id="pv-error" class="alert err" hidden></div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section data-route="settings" class="route" hidden>
      <h2>Settings</h2>
      <p>Modo local-first con opci√≥n de <strong>Cloud mode (GitHub data repo)</strong>.</p>

      <h3>Cloud</h3>
      <label><input type="checkbox" id="cloud-mode"> Cloud mode (GitHub)</label>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="sync-cloud">Sync desde nube ‚Üí local</button>
        <button class="btn" id="migrate-cloud">Migrar locales ‚Üí nube</button>
      </div>

      <h3 style="margin-top:16px">Acento</h3>
      <select id="color-accent">
        <option value="#7aa2ff">Azul</option><option value="#52d6ca">Turquesa</option>
        <option value="#ff7ab6">Magenta</option><option value="#ffd166">√Åmbar</option>
      </select>

      <h3>APIs (local dev)</h3>
      <div id="secrets-local">
        <label>OpenAI API Key</label><input id="openai-key" type="password" placeholder="sk-...">
        <label>OpenAI Assistant ID</label><input id="openai-asst" placeholder="asst_...">
      </div>
      <div id="secrets-prod" class="alert" hidden>En producci√≥n se usan variables de entorno.</div>

      <div class="row" style="margin-top:12px">
        <button class="btn" id="toggle-visibility" type="button">Mostrar</button>
        <button class="btn primary" id="save-settings" type="button">Guardar</button>
      </div>

      <div class="row" style="margin-top:8px">
        <button class="btn" id="export-all" type="button">Exportar settings + proyectos</button>
        <input type="file" id="import-file" accept="application/json" style="display:none">
        <button class="btn" id="import-all" type="button">Importar (merge/sobrescribir)</button>
        <button class="btn" id="clear-all" type="button">Borrar TODO</button>
      </div>
      <div id="settings-info" class="alert" hidden></div>
      <div id="settings-errors" class="alert err" hidden></div>
    </section>

    <!-- PROFILE -->
    <section data-route="profile" class="route" hidden>
      <h2>Perfil</h2>
      <div class="cards" id="conn-cards"></div>
    </section>
  </main>
</div>

<script>
const STATE_KEY='pcentral-state';
const $=s=>document.querySelector(s);
const routes=['dashboard','new','preview','settings','profile'];
const IS_PROD = !/^(localhost|127\.0\.0\.1)/.test(location.hostname);

window.addEventListener('hashchange', renderRoute);
window.addEventListener('DOMContentLoaded', ()=>{
  if(!localState()) setLocalState({version:1,savedAt:Date.now(),settings:{},projects:[]});
  renderRoute(); loadSettingsIntoUI(); renderProjects(); wireNewForm(); renderConnections(); bindGlobalMenuClose();
  const st = getSettings();
  if(st.cloudMode){ syncFromCloud().then(()=>renderProjects()).catch(()=>{}); }
});

/* ===== State helpers (local cache) ===== */
function localState(){
  try { return JSON.parse(localStorage.getItem(STATE_KEY)||''); } catch { return null; }
}
function setLocalState(next){
  localStorage.setItem(STATE_KEY, JSON.stringify({version:1, savedAt:Date.now(), settings: next.settings||{}, projects: next.projects||[]}));
}
function getSettings(){ const st=localState(); return (st && st.settings) || {}; }
function setSettings(s){ const st=localState()||{settings:{},projects:[]}; st.settings=s||{}; setLocalState(st); }
function loadProjectsLocal(){ const st=localState(); return (st && st.projects) || []; }
function saveProjectsLocal(arr){ const st=localState()||{settings:{},projects:[]}; st.projects=Array.isArray(arr)?arr:[]; setLocalState(st); }

function getProjectKey(p){ return p?.id || p?.slug; }
function findProjectByIdOrSlug(id){ return loadProjectsLocal().find(p=>p.id===id || p.slug===id); }

function routeEls(){return document.querySelectorAll('.route')}
function renderRoute(){
  const hash = location.hash.replace('#/','') || 'dashboard';
  const [route, query] = hash.split('?');
  routeEls().forEach(sec=>sec.hidden=true);
  const found = routes.includes(route) ? route : 'dashboard';
  document.querySelector(`[data-route="${found}"]`).hidden=false;
  document.querySelectorAll('.nav a').forEach(a=>a.setAttribute('aria-current', a.getAttribute('href')===`#/${found}`?'page':'false'));
  if(found==='preview'){ renderPreview(new URLSearchParams(query||'')); }
  if(found==='new'){ resetNewFormUI(); }
  $('#main').focus();
}

/* ===== Utility (id/slug) ===== */
function uuid(){return 'p-'+Math.random().toString(36).slice(2,8)+'-'+Date.now().toString(36)}
function slugify(s){return (s||'').toLowerCase().replace(/[^a-z0-9-]+/g,'-').replace(/^-+|-+$/g,'').slice(0,60)||'site'}

/* ===== GitHub Cloud API client (via Netlify Functions) ===== */
async function apiListProjects(){
  const r = await fetch('/.netlify/functions/projects-list');
  const data = await r.json().catch(()=>({}));
  if(!r.ok) throw new Error(data.error || 'github_list_error');
  // Normaliza: puede llegar como array de strings o array de objetos parciales
  const arr = Array.isArray(data.projects)? data.projects : [];
  return arr.map(x=>{
    if(typeof x === 'string') return { id:x, slug:x, name:x };
    const id = x.id || x.slug || slugify(x.name||'');
    const name = x.name || x.slug || id;
    return { ...x, id, slug: x.slug || id, name };
  });
}
async function apiGetProject(id){
  const r = await fetch('/.netlify/functions/projects-get?id='+encodeURIComponent(id));
  const data = await r.json().catch(()=>({}));
  if(!r.ok) throw Object.assign(new Error(data.error||'github_get_error'), {data});
  return data;
}
async function apiSaveProject(project, files){
  const r = await fetch('/.netlify/functions/projects-save', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ project, files })});
  const data = await r.json().catch(()=>({}));
  if(!r.ok) throw Object.assign(new Error(data.error||'github_save_error'), {data});
  return data;
}
async function apiDeleteProject(id){
  const r = await fetch('/.netlify/functions/projects-delete', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id })});
  const data = await r.json().catch(()=>({}));
  if(!r.ok) throw Object.assign(new Error(data.error||'github_delete_error'), {data});
  return data;
}
async function syncFromCloud(){
  const remote = await apiListProjects();
  const st = localState()||{settings:{},projects:[]};
  const map=new Map();
  (st.projects||[]).forEach(p=>{ const k=getProjectKey(p); if(k) map.set(k,{...p, id:k}); });
  (remote||[]).forEach(p=>{ const k=getProjectKey(p); if(k) map.set(k,{...p, id:k}); });
  st.projects = Array.from(map.values());
  setLocalState(st);
}

/* ===== Projects rendering/list ===== */
function renderProjects(){
  const list=loadProjectsLocal(); const ul=$('#projects-list'); ul.innerHTML='';
  $('#projects-empty').hidden=list.length>0;
  for(const p of list){
    const key=getProjectKey(p); if(!key) continue;
    const li=document.createElement('li'); li.className='card'; li.dataset.id = key;
    li.innerHTML=`
      <div class="menu-wrap">
        <button class="menu-btn" aria-haspopup="true" aria-expanded="false" aria-controls="menu-${key}" data-menu-btn data-id="${key}" title="M√°s acciones">‚ãÆ</button>
        <div class="menu" id="menu-${key}" role="menu" aria-hidden="true">
          <button role="menuitem" data-act="view" data-id="${key}">Ver</button>
          <button role="menuitem" data-act="zip" data-id="${key}">Descargar ZIP</button>
          <button role="menuitem" data-act="push" data-id="${key}">Push a GitHub</button>
          <button role="menuitem" data-act="deploy-real" data-id="${key}">Deploy en Netlify</button>
          <hr style="border:none;height:1px;background:#2b3b77;margin:6px 4px">
          <button role="menuitem" class="danger" data-act="delete" data-id="${key}">Eliminar</button>
        </div>
      </div>
      <h3 style="padding-right:36px">${p.name||p.slug||key}</h3>
      <p>${p.desc||''}</p>
      <div class="row" style="margin-bottom:8px"><span class="tag">${p.status||'local'}</span>${p.repo?`<span class="tag">${p.repo}</span>`:''}</div>
      <div class="row">
        <button class="btn" data-act="view" data-id="${key}">Ver sitio</button>
        <button class="btn" data-act="zip" data-id="${key}">Descargar ZIP</button>
        <button class="btn" data-act="push" data-id="${key}">Push a GitHub</button>
        <button class="btn" data-act="deploy-real" data-id="${key}">Deploy Netlify</button>
      </div>`;
    ul.appendChild(li);
  }

  ul.querySelectorAll('[data-menu-btn]').forEach(btn=>{
    btn.onclick=(e)=>{
      const id=btn.dataset.id;
      const menu=ul.querySelector('#menu-'+CSS.escape(id));
      const open = menu.getAttribute('aria-hidden')==='false';
      closeAllMenus();
      if(!open){ menu.setAttribute('aria-hidden','false'); btn.setAttribute('aria-expanded','true'); }
      e.stopPropagation();
    };
  });

  ul.onclick=async(e)=>{
    const btn=e.target.closest('button[data-act]'); if(!btn) return;
    const id=btn.dataset.id; const proj=findProjectByIdOrSlug(id); if(!proj) return;
    const action=btn.dataset.act;
    closeAllMenus();
    if(action==='view'){ openPreview(proj); }
    if(action==='zip'){
      const blob=makeZip(proj.files||{}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`${(proj.name||proj.slug||'site')}.zip`; a.click(); URL.revokeObjectURL(a.href);
    }
    if(action==='push'){ alert('Push a GitHub: usa tu funci√≥n existente (sin cambios).'); }
    if(action==='deploy-real'){ alert('Trigger Netlify: usa tu funci√≥n existente (sin cambios).'); }
    if(action==='delete'){
      if(confirm('¬øSeguro que quieres borrar este proyecto?')){ await deleteProject(getProjectKey(proj)); renderProjects(); }
    }
  };
}

function closeAllMenus(){
  document.querySelectorAll('.menu').forEach(m=>m.setAttribute('aria-hidden','true'));
  document.querySelectorAll('[data-menu-btn]').forEach(b=>b.setAttribute('aria-expanded','false'));
}
function bindGlobalMenuClose(){
  document.addEventListener('click', (e)=>{
    if(!e.target.closest('.menu') && !e.target.closest('[data-menu-btn]')) closeAllMenus();
  });
}

/* ===== ZIP (store) ===== */
const CRC_TABLE=(()=>{let c,t=[];for(let n=0;n<256;n++){c=n;for(let k=0;k<8;k++){c=c&1?0xedb88320^(c>>>1):c>>>1}t[n]=c>>>0}return t})();
function crc32Uint8(a){let c=0xffffffff;for(let i=0;i<a.length;i++){c=CRC_TABLE[(c^a[i])&0xff]^(c>>>8)}return (c^0xffffffff)>>>0}
function strToU8(s){return new TextEncoder().encode(s)}
function writeU16(v,o,x){v.setUint16(o,x,true);return o+2}
function writeU32(v,o,x){v.setUint32(o,x,true);return o+4}
function dosTimeDate(d=new Date()){const t=((d.getHours()&0x1f)<<11)|((d.getMinutes()&0x3f)<<5)|((Math.floor(d.getSeconds()/2))&0x1f);const da=(((d.getFullYear()-1980)&0x7f)<<9)|(((d.getMonth()+1)&0xf)<<5)|((d.getDate())&0x1f);return{time:t,date:da}}
function makeZip(files){
  const names=Object.keys(files||{});
  const fileRecords=[];
  let localSize=0;
  const chunks=[];
  for(const name of names){
    const nameU8=strToU8(name);
    const dataU8=strToU8(files[name]);
    const crc=crc32Uint8(dataU8);
    const {time,date}=dosTimeDate(new Date());
    const need=30+nameU8.length+dataU8.length;
    const buf=new ArrayBuffer(need);
    const view=new DataView(buf); let off=0;
    off=writeU32(view,off,0x04034b50);
    off=writeU16(view,off,20);
    off=writeU16(view,off,0);
    off=writeU16(view,off,0);
    off=writeU16(view,off,time);
    off=writeU16(view,off,date);
    off=writeU32(view,off,crc);
    off=writeU32(view,off,dataU8.length);
    off=writeU32(view,off,dataU8.length);
    off=writeU16(view,off,nameU8.length);
    off=writeU16(view,off,0);
    new Uint8Array(buf,off,nameU8.length).set(nameU8); off+=nameU8.length;
    new Uint8Array(buf,off,dataU8.length).set(dataU8); off+=dataU8.length;
    chunks.push(new Uint8Array(buf));
    fileRecords.push({nameU8,crc,size:dataU8.length,compSize:dataU8.length,time,date,localHeaderOffset:localSize});
    localSize+=need;
  }
  const centralChunks=[]; let centralSize=0;
  for(const rec of fileRecords){
    const need=46+rec.nameU8.length;
    const buf=new ArrayBuffer(need);
    const view=new DataView(buf); let off=0;
    off=writeU32(view,off,0x02014b50);
    off=writeU16(view,off,20);
    off=writeU16(view,off,20);
    off=writeU16(view,off,0);
    off=writeU16(view,off,0);
    off=writeU16(view,off,rec.time);
    off=writeU16(view,off,rec.date);
    off=writeU32(view,off,rec.crc);
    off=writeU32(view,off,rec.compSize);
    off=writeU32(view,off,rec.size);
    off=writeU16(view,off,rec.nameU8.length);
    off=writeU16(view,off,0);
    off=writeU16(view,off,0);
    off=writeU16(view,off,0);
    off=writeU16(view,off,0);
    off=writeU32(view,off,0);
    off=writeU32(view,off,rec.localHeaderOffset);
    new Uint8Array(buf,off,rec.nameU8.length).set(rec.nameU8); off+=rec.nameU8.length;
    centralChunks.push(new Uint8Array(buf));
    centralSize+=need;
  }
  const endBuf=new ArrayBuffer(22);
  const endView=new DataView(endBuf); let off=0;
  off=writeU32(endView,off,0x06054b50);
  off=writeU16(endView,off,0);
  off=writeU16(endView,off,0);
  off=writeU16(endView,off,fileRecords.length);
  off=writeU16(endView,off,fileRecords.length);
  off=writeU32(endView,off,centralSize);
  off=writeU32(endView,off,localSize);
  off=writeU16(endView,off,0);
  const totalLen=localSize+centralSize+22;
  const out=new Uint8Array(totalLen);
  let pos=0; for(const c of chunks){ out.set(c,pos); pos+=c.length; }
  for(const c of centralChunks){ out.set(c,pos); pos+=c.length; }
  out.set(new Uint8Array(endBuf),pos);
  return new Blob([out],{type:'application/zip'});
}

/* ===== OpenAI headers (local dev) ===== */
function getSettingsSafe(){ try { return (JSON.parse(localStorage.getItem(STATE_KEY)||'{}').settings)||{} } catch { return {}; } }
function buildOpenAIHeaders(){
  const headers = {'Content-Type':'application/json'};
  if(!IS_PROD){
    const st = getSettingsSafe();
    if(st.openaiKey) headers['x-openai-key'] = st.openaiKey;
    if(st.openaiAsst) headers['x-openai-asst'] = st.openaiAsst;
  }
  return headers;
}

/* ===== New / Generate ===== */
function generateSite({name,prompt}){
  const accent=(getSettings().accent)||'#7aa2ff';
  const css=`:root{--color-primary:${accent};--color-bg:#fff;--font-heading:system-ui;--font-body:system-ui}body{margin:0;background:var(--color-bg);color:#111;font:16px/1.65 system-ui}`;
  const body=`<main class="wrap"><h1>${escapeHtml(name)}</h1><p>${escapeHtml(prompt)}</p></main>`;
  return {files:{'index.html':`<!doctype html><html lang="es"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>${escapeHtml(name)}</title><style>${css}</style></head><body>${body}</body></html>`}};
}
function escapeHtml(s=''){return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]))}

function wireNewForm(){
  const form=$('#new-form'); const info=$('#form-info'); const errors=$('#form-errors');
  $('#preview-btn').onclick=()=>{
    const prompt=$('#prompt').value.trim(); const name=$('#name').value.trim()||'proyecto';
    if(!prompt){ errors.hidden=false; errors.textContent='El prompt es requerido.'; return; }
    const gen=generateSite({name,prompt}); const iframe=$('#preview');
    iframe.src=URL.createObjectURL(new Blob([gen.files['index.html']],{type:'text/html'}));
    $('#local-preview').hidden=false; info.hidden=false; info.textContent='Preview local generado.'; errors.hidden=true;
  };
  form.onsubmit=async(e)=>{
    e.preventDefault();
    const prompt=$('#prompt').value.trim(); const name=$('#name').value.trim(); const desc=$('#desc').value.trim();
    if(!prompt||!name){ errors.hidden=false; errors.textContent='Prompt y Nombre son obligatorios.'; return; }
    const slug=slugify(name); const id=uuid();
    let files;
    try{
      const r=await fetch('/.netlify/functions/generate',{method:'POST',headers:buildOpenAIHeaders(),body:JSON.stringify({prompt,name})});
      const data=await r.json(); if(!r.ok) throw new Error(data.error||'Error de generaci√≥n'); files = data.files;
    }catch(err){
      files = generateSite({name,prompt}).files;
    }
    const proj={id,name,slug,desc,status:'generated',files,createdAt:Date.now(),updatedAt:Date.now()};
    await upsertProject(proj);
    form.reset(); $('#local-preview').hidden=true; info.hidden=true; errors.hidden=true;
    location.hash = `#/preview?id=${encodeURIComponent(id)}`;
  };
}
function resetNewFormUI(){ const form=$('#new-form'); if(!form) return; form.reset(); $('#form-info').hidden=true; $('#form-errors').hidden=true; $('#local-preview').hidden=true; }

/* ===== Upsert/Delete con Cloud mode ===== */
async function upsertProject(p){
  const key = getProjectKey(p) || (p.slug ? (p.id=p.slug) : null);
  const cur = loadProjectsLocal();
  const i = cur.findIndex(x=>getProjectKey(x)===key);
  if(i>=0) cur[i]={...cur[i],...p}; else cur.unshift({...p, id:key});
  saveProjectsLocal(cur);

  const st=getSettings();
  if(st.cloudMode){
    const meta={...p}; delete meta.files; if(!meta.id) meta.id = key; if(!meta.slug) meta.slug = key;
    try{ await apiSaveProject(meta, p.files||{}); }catch(err){ alert('Error guardando en nube: '+(err.message||'')); }
  }
  renderProjects();
}
async function deleteProject(id){
  const cur = loadProjectsLocal().filter(p=>getProjectKey(p)!==id);
  saveProjectsLocal(cur);
  const st=getSettings();
  if(st.cloudMode){
    try{ await apiDeleteProject(id); }catch(err){ alert('Error borrando en nube: '+(err.message||'')); }
  }
}

/* ===== Preview ===== */
function getProjectByIdLocal(id){ return findProjectByIdOrSlug(id); }
function openPreview(projOrId){ const id = typeof projOrId==='string' ? projOrId : getProjectKey(projOrId); if(!id) return; location.hash = `#/preview?id=${encodeURIComponent(id)}`; }
async function renderPreview(params){
  const id = params.get('id');
  let proj = id ? getProjectByIdLocal(id) : null;
  if(!proj){ location.hash='#/dashboard'; return; }

  // üîß FIX: siempre intentamos traer los archivos desde la nube si faltan (independiente de cloudMode)
  if(!proj.files || !proj.files['index.html']){
    try{
      const data = await apiGetProject(id);
      if(data && data.files){
        proj = {...proj, files: data.files};
        // guarda en local sin forzar push a nube
        const st=getSettings(); const before=!!st.cloudMode; st.cloudMode=false; setSettings(st);
        await upsertProject(proj);
        // restaurar cloudMode
        st.cloudMode=before; setSettings(st);
      }
    }catch{}
  }

  const pvTitle = $('#pv-title'); const pvInfo=$('#pv-info'); const pvErr=$('#pv-error');
  pvTitle.textContent = `Preview ‚Äî ${proj.name||proj.slug||id}`;
  const iframe = $('#pv-iframe');
  const html = (proj.files && proj.files['index.html']) ? proj.files['index.html'] : '<h1>Sin index.html</h1>';
  iframe.src = URL.createObjectURL(new Blob([html],{type:'text/html'}));

  $('#pv-download').onclick=()=>{ const blob=makeZip(proj.files||{}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`${(proj.name||proj.slug||'site')}.zip`; a.click(); URL.revokeObjectURL(a.href); };

  $('#pv-apply-ai').onclick = async ()=>{
    pvInfo.hidden=false; pvInfo.textContent='Aplicando cambios con IA...'; pvErr.hidden=true;
    try{
      const prompt = ($('#pv-prompt').value||'').trim(); if(!prompt) throw new Error('Escribe un prompt');
      const r = await fetch('/.netlify/functions/generate', { method:'POST', headers: buildOpenAIHeaders(), body: JSON.stringify({ mode:'edit', prompt, name: proj.name, files: proj.files }) });
      const data = await r.json();
      if(!r.ok || !data.files) throw new Error(data.error||'La funci√≥n no devolvi√≥ archivos');
      const updated = {...proj, files: data.files, status:'edited', updatedAt: Date.now()};
      await upsertProject(updated);
      renderPreview(new URLSearchParams(`id=${encodeURIComponent(getProjectKey(proj))}`)); pvInfo.textContent='Cambios aplicados (IA).';
    }catch(err){ pvInfo.hidden=true; pvErr.hidden=false; pvErr.textContent='Error: '+(err.message||''); }
  };
  $('#pv-apply-local').onclick = ()=>{
    const txt = ($('#pv-prompt').value||'').trim();
    const updatedFiles = localEdit(proj.files||{}, txt);
    const updated = {...proj, files: updatedFiles, status:'edited', updatedAt: Date.now()};
    upsertProject(updated).then(()=>{
      renderPreview(new URLSearchParams(`id=${encodeURIComponent(getProjectKey(proj))}`));
      pvInfo.hidden=false; pvInfo.textContent='Cambios aplicados (local).'; pvErr.hidden=true;
    });
  };
}

function localEdit(files, promptText){
  const src = files['index.html']||'<html><body><h1>Sin index.html</h1></body></html>';
  let out = src;
  if(/oscuro|dark/i.test(promptText)){ out = out.replace('<style>', '<style>body{background:#0b0f1c;color:#f2f4ff;}'); }
  out = out.replace('</body>', `<section style="padding:24px;border-top:1px solid #ddd"><h3>Cambio aplicado</h3><p>${escapeHtml(promptText||'Actualizaci√≥n')}</p></section></body>`);
  return {...files, 'index.html': out};
}

/* ===== Settings ===== */
function loadSettingsIntoUI(){
  const st=getSettings();
  $('#cloud-mode').checked = !!st.cloudMode;
  $('#sync-cloud').onclick = async()=>{ try{ await syncFromCloud(); renderProjects(); info('Sincronizado desde nube'); }catch(e){ err('No se pudo sincronizar'); } };
  $('#migrate-cloud').onclick = async()=>{
    try{
      const list = loadProjectsLocal();
      if(!confirm(`Subir ${list.length} proyectos al repositorio de datos?`)) return;
      for(const p of list){
        const meta={...p}; delete meta.files; if(!meta.id) meta.id=getProjectKey(p); if(!meta.slug) meta.slug=getProjectKey(p);
        await apiSaveProject(meta, p.files||{});
      }
      info('Migraci√≥n completada');
    }catch(e){ err('Error migrando: '+(e.message||'')); }
  };

  if(st.accent){ $('#color-accent').value=st.accent; document.documentElement.style.setProperty('--pri',st.accent); }
  $('#secrets-local').hidden = IS_PROD;
  $('#secrets-prod').hidden = !IS_PROD;
  if(!IS_PROD){
    if(st.openaiKey) $('#openai-key').value = st.openaiKey;
    if(st.openaiAsst) $('#openai-asst').value = st.openaiAsst;
  }

  $('#save-settings').onclick=()=>{
    const next={
      cloudMode: $('#cloud-mode').checked,
      accent: $('#color-accent').value
    };
    if(!IS_PROD){
      next.openaiKey = ($('#openai-key').value||'').trim();
      next.openaiAsst = ($('#openai-asst').value||'').trim();
    }
    setSettings(next);
    document.documentElement.style.setProperty('--pri',next.accent||'#7aa2ff');
    info('Preferencias guardadas');
    if(next.cloudMode){ syncFromCloud().then(()=>renderProjects()); }
  };

  $('#toggle-visibility').onclick=()=>{
    const inputs=[...document.querySelectorAll('#secrets-local input[type="password"]')];
    if(!inputs.length) return;
    const show = inputs.some(i=>i.type==='password');
    inputs.forEach(i=>i.type= show ? 'text' : 'password');
    $('#toggle-visibility').textContent = show ? 'Ocultar' : 'Mostrar';
  };

  $('#export-all').onclick=()=>{
    const payload = {...localState(), exportedAt: Date.now()};
    const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='project-central-export.json'; a.click(); URL.revokeObjectURL(a.href);
  };
  $('#import-all').onclick=()=> $('#import-file').click();
  $('#import-file').onchange=(e)=>{
    const file=e.target.files[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload=()=>{
      try{
        const incoming=JSON.parse(reader.result);
        const overwrite = confirm('¬øSobrescribir TODO? Cancel = MERGE.');
        if(overwrite){ setLocalState({settings: incoming.settings||{}, projects: (incoming.projects||[]).map(p=>({...p, id:getProjectKey(p)}))}); }
        else{
          const cur=localState()||{settings:{},projects:[]};
          const mergedSettings = {...cur.settings, ...(incoming.settings||{})};
          const map=new Map(); (cur.projects||[]).forEach(p=>{const k=getProjectKey(p); if(k) map.set(k,{...p,id:k});}); (incoming.projects||[]).forEach(p=>{const k=getProjectKey(p); if(k) map.set(k,{...p,id:k});});
          setLocalState({settings: mergedSettings, projects: Array.from(map.values())});
        }
        loadSettingsIntoUI(); renderProjects(); renderConnections(); info('Importaci√≥n completada');
      }catch(e){ err('Error importando: '+e.message); }
    };
    reader.readAsText(file);
  };
  $('#clear-all').onclick=()=>{ if(confirm('¬øBorrar TODOS los settings y proyectos (solo local)?')){ setLocalState({settings:{},projects:[]}); loadSettingsIntoUI(); renderProjects(); renderConnections(); info('Todo borrado'); } };
}
function info(m){ const el=$('#settings-info'); el.hidden=false; el.textContent=m; setTimeout(()=>el.hidden=true, 2000); }
function err(m){ const el=$('#settings-errors'); el.hidden=false; el.textContent=m; setTimeout(()=>el.hidden=true, 4000); }

function renderConnections(){
  const st=getSettings(); const wrap=$('#conn-cards');
  const items=[
    {name:'GitHub (data repo)', ok: st.cloudMode ? true : false},
    {name:'OpenAI (server)', ok: IS_PROD ? true : !!st.openaiKey}
  ];
  wrap.innerHTML=items.map(i=>`<div class="card"><h3>${i.name}</h3><p>${i.ok?'OK':'Sin configurar'}</p></div>`).join('');
}
</script>
</body>
</html>
