<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Project Central — Prod Fixed</title>
<style>
:root{--bg:#0b0f1c;--panel:#ffffff10;--ink:#eef1ff;--pri:#7aa2ff;--danger:#ff6d8c}
*{box-sizing:border-box}body{margin:0;background:linear-gradient(180deg,#0b0f1c,#0d142c);color:var(--ink);font:15px/1.6 system-ui}
.layout{display:grid;grid-template-columns:280px 1fr;min-height:100vh}
aside{padding:18px;background:var(--panel);backdrop-filter: blur(10px);border-right:1px solid #ffffff22}
main{padding:26px}
.nav a{display:block;padding:10px 12px;margin:6px 0;border-radius:10px;color:inherit;text-decoration:none}
.nav a[aria-current="page"]{background:#ffffff18;border:1px solid #ffffff33}
.btn{display:inline-flex;gap:8px;align-items:center;padding:9px 12px;border-radius:10px;background:#101632;border:1px solid #ffffff22;color:var(--ink);cursor:pointer}
.btn.primary{background:linear-gradient(135deg,#7aa2ff,#52d6ca);color:#081022;border:none}
.cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;margin-top:12px}
.card{position:relative;background:var(--panel);border:1px solid #ffffff22;border-radius:14px;padding:14px}
label{display:block;margin:10px 0 6px}
input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid #ffffff33;background:#0a1026;color:var(--ink)}
.alert{margin-top:12px;padding:10px;border-radius:10px;border:1px solid #2b9;background:#173b3a}
.alert.err{border-color:#b24;background:#381b26}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.tag{font-size:12px;padding:2px 8px;border-radius:999px;background:#ffffff18;border:1px solid #ffffff33}
.preview iframe,.preview-iframe{width:100%;height:60vh;background:white;border-radius:10px;border:1px solid #ffffff22}
.menu-wrap{position:absolute; right:10px; top:10px}
.menu-btn{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:8px;border:1px solid #ffffff33;background:#0a1026;cursor:pointer}
.menu-btn:hover{background:#0d1430}
.menu{position:absolute; right:0; margin-top:6px; min-width:200px; background:#0b1028; border:1px solid #2b3b77; border-radius:12px; padding:6px; box-shadow:0 10px 30px rgba(0,0,0,.35); display:none; z-index:10}
.menu[aria-hidden="false"]{display:block}
.menu button{width:100%; text-align:left; padding:8px 10px; border:none; background:transparent; color:var(--ink); border-radius:8px; cursor:pointer}
.menu button:hover{background:#ffffff12}
.menu .danger{color:var(--danger)}
.kbd{font: 11px/1.2 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; padding:3px 6px; border-radius:6px; background:#0008; border:1px solid #fff2}
@media (max-width:980px){.layout{grid-template-columns:1fr}}

/* Variables y mínimos */
:root{
  --color-primary:#ff2ea1; --color-ink:#111; --color-bg:#fff;
  --radius:14px; --space-1:8px; --space-2:12px; --space-3:16px; --space-4:24px;
}
.carousel{ position:relative; overflow:hidden; border-radius: var(--radius); background: #0002; }
.carousel .track{
  display:grid; grid-auto-flow:column; grid-auto-columns:100%;
  transition: transform .4s ease; will-change: transform;
}
.slide{ margin:0; position:relative; }
.slide img{ width:100%; height:auto; display:block; }
.slide figcaption{ position:absolute; left:0; bottom:0; padding: var(--space-2) var(--space-3);
  color:#fff; background: linear-gradient(transparent, #0008); width:100%; font-size:.95rem; }

.carousel .prev, .carousel .next{
  position:absolute; top:50%; transform: translateY(-50%);
  background:#000a; color:#fff; border:none; width:40px; height:40px; border-radius:999px;
  display:grid; place-items:center; cursor:pointer;
}
.carousel .prev{ left:10px } .carousel .next{ right:10px }
.carousel .prev:focus-visible, .carousel .next:focus-visible{ outline:2px solid var(--color-primary) }

.carousel .dots{
  position:absolute; left:50%; transform:translateX(-50%); bottom:8px;
  display:flex; gap:6px; padding:6px 8px; background:#0006; border-radius: 999px;
}
.carousel .dots button{
  width:8px; height:8px; border-radius:999px; border:0; background:#fff9; cursor:pointer;
}
.carousel .dots button.is-active{ background: var(--color-primary); }
@media (prefers-reduced-motion: reduce){
  .carousel .track{ transition:none }
}

#faq{ padding: var(--space-4) 0 }
.faq{ border-bottom: 1px solid #ffffff22; padding: var(--space-2) 0 }
.faq-q{
  width:100%; text-align:left; background:transparent; border:none; color:inherit;
  font: inherit; padding: var(--space-2) 0; cursor:pointer;
}
.faq-q:focus-visible{ outline:2px solid var(--color-primary) }
.faq-a{ padding: 0 0 var(--space-2) 0; color: #dbe0ff; }


</style>
</head>
<body>
<div class="layout">
  <aside>
    <h2 style="margin:0 0 8px">Project Central</h2>
    <nav class="nav">
      <a href="#/dashboard" aria-current="page">Dashboard</a>
      <a href="#/new">New Project</a>
      <a href="#/settings">Settings</a>
      <a href="#/profile">Profile</a>
    </nav>
  </aside>
  <main id="main" tabindex="-1">
    <!-- DASHBOARD -->
    <section data-route="dashboard" class="route">
      <header class="row" style="justify-content:space-between">
        <h2 style="margin:0">Proyectos</h2>
        <div class="row"><a class="btn primary" href="#/new">+ Nuevo proyecto</a></div>
      </header>
      <div id="projects-empty" class="alert" hidden>Aún no hay proyectos.</div>
      <ul id="projects-list" class="cards" role="list" aria-live="polite"></ul>
    </section>

    <!-- NEW -->
    <section data-route="new" class="route" hidden>
      <h2>Nuevo proyecto</h2>
      <form id="new-form" novalidate>
        <label for="prompt">Prompt del sitio</label>
        <textarea id="prompt" rows="6" required placeholder="Brief de la landing (secciones, estilo, etc.)"></textarea>
        <label for="name">Nombre del proyecto</label>
        <input id="name" required placeholder="creative-studio">
        <label for="desc">Descripción</label><input id="desc" placeholder="Landing para estudio...">
        <div class="row" style="margin-top:10px">
          <button class="btn primary" type="submit">Generar</button>
          <button class="btn" type="button" id="preview-btn">Previsualizar</button>
        </div>
        <div id="form-errors" class="alert err" hidden></div>
        <div id="form-info" class="alert" hidden></div>
      </form>
      <div id="local-preview" class="preview" hidden>
        <h3>Preview</h3>
        <iframe id="preview" title="Previsualización"></iframe>
      </div>
    </section>

    <!-- PREVIEW -->
    <section data-route="preview" class="route" hidden>
      <header class="row" style="justify-content:space-between">
        <h2 id="pv-title" style="margin:0">Preview</h2>
        <div class="row">
          <a class="btn" href="#/dashboard">Volver</a>
          <button class="btn" id="pv-download">Descargar ZIP</button>
        </div>
      </header>
      <div class="preview">
        <iframe id="pv-iframe" class="preview-iframe" title="Vista previa del sitio"></iframe>
      </div>
      <div style="margin-top:12px">
        <label for="pv-prompt">Modificar con prompt</label>
        <textarea id="pv-prompt" rows="5" placeholder="Ej.: Oscurece el tema y añade sección de precios con 3 planes"></textarea>
        <div class="row" style="margin-top:8px">
          <button class="btn primary" id="pv-apply-ai">Aplicar cambios (IA)</button>
          <button class="btn" id="pv-apply-local">Aplicar cambios (local)</button>
        </div>
        <div id="pv-info" class="alert" hidden></div>
        <div id="pv-error" class="alert err" hidden></div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section data-route="settings" class="route" hidden>
      <h2>Settings</h2>
      <p>En <span class="kbd">localhost</span> puedes usar claves locales. En producción se usarán <strong>variables de entorno</strong> y se ocultarán los campos sensibles.</p>
      <label>Acento</label>
      <select id="color-accent">
        <option value="#7aa2ff">Azul</option><option value="#52d6ca">Turquesa</option>
        <option value="#ff7ab6">Magenta</option><option value="#ffd166">Ámbar</option>
      </select>

      <h3>APIs</h3>
      <div id="secrets-local">
        <label>GitHub Token</label><input id="gh-token" type="password" placeholder="ghp_...">
        <label>Netlify Token</label><input id="netlify-token" type="password" placeholder="token netlify">
        <div class="row"><div style="flex:1">
          <label>OpenAI API Key</label><input id="openai-key" type="password" placeholder="sk-...">
        </div><div style="flex:1">
          <label>OpenAI Assistant ID</label><input id="openai-asst" placeholder="asst_...">
        </div></div>
      </div>
      <div id="secrets-prod" class="alert" hidden>En producción, las claves se leen del servidor (variables de entorno). Estos campos se han ocultado.</div>

      <h3>Repos / Deploy</h3>
      <div class="row"><div style="flex:1">
        <label>GitHub Owner</label><input id="gh-owner" placeholder="tu-usuario">
      </div><div style="flex:1">
        <label>GitHub Repo (por proyecto)</label><input id="gh-repo" placeholder="mi-landing">
      </div></div>
      <div class="row"><div style="flex:1">
        <label>Netlify Site ID</label><input id="netlify-site" placeholder="xxxxx-xxxxxx">
      </div><div style="flex:1">
        <label>Netlify Build Hook URL</label><input id="netlify-hook" placeholder="https://api.netlify.com/build_hooks/...">
      </div></div>

      <div class="row" style="margin-top:12px">
        <button class="btn" id="toggle-visibility" type="button">Mostrar</button>
        <button class="btn primary" id="save-settings" type="button">Guardar</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="export-all" type="button">Exportar settings + proyectos</button>
        <input type="file" id="import-file" accept="application/json" style="display:none">
        <button class="btn" id="import-all" type="button">Importar (merge/sobrescribir)</button>
        <button class="btn" id="clear-all" type="button">Borrar TODO</button>
      </div>
      <div id="settings-info" class="alert" hidden></div>
      <div id="settings-errors" class="alert err" hidden></div>
    </section>

    <!-- PROFILE -->
    <section data-route="profile" class="route" hidden>
      <h2>Perfil</h2>
      <div class="cards" id="conn-cards"></div>
    </section>
  </main>
</div>

<div class="carousel" data-carousel id="gallery">
  <div class="track">
    <figure class="slide">
      <picture>
        <!-- Ejemplo con responsive -->
        <source srcset="assets/gallery/01-800.jpg 800w, assets/gallery/01-1200.jpg 1200w" sizes="(min-width: 900px) 800px, 100vw" type="image/jpeg">
        <img src="assets/gallery/01-800.jpg" alt="Escalada modular 1" loading="lazy" decoding="async">
      </picture>
      <figcaption>Climber on a modular wall</figcaption>
    </figure>

    <!-- Repite .slide por cada imagen -->
  </div>

  <button class="prev" aria-label="Anterior" data-prev>‹</button>
  <button class="next" aria-label="Siguiente" data-next>›</button>
  <div class="dots" aria-label="Paginación" data-dots></div>
</div>

<section id="faq" aria-label="Preguntas frecuentes">
  <div class="faq">
    <button class="faq-q" aria-expanded="false">
      ¿Cómo funciona la instalación?
    </button>
    <div class="faq-a" hidden>
      Instalamos en 48–72h, con certificación de seguridad y manual de uso.
    </div>
  </div>
  <!-- Repite .faq tantas veces como preguntas -->
</section>


<script>
const STATE_KEY='pcentral-state';
const $=s=>document.querySelector(s);
const routes=['dashboard','new','preview','settings','profile'];
const IS_PROD = !/^(localhost|127\.0\.0\.1)/.test(location.hostname);

async function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
async function postJSON(url, body){
  const r = await fetch(url, {
    method:'POST',
    headers: buildOpenAIHeaders(),
    body: JSON.stringify(body||{})
  });
  const ct = r.headers.get('content-type') || '';
  const text = await r.text();
  let data=null; try{ data = text ? JSON.parse(text) : null }catch{}
  if(!r.ok){
    const msg = (data && data.error) ? data.error : (text || (r.status+' '+r.statusText));
    throw new Error(String(msg).slice(0,500));
  }
  if(!data) throw new Error('Respuesta vacía del servidor');
  return data;
}

window.addEventListener('hashchange', renderRoute);
window.addEventListener('DOMContentLoaded', ()=>{
  if(!localStorage.getItem(STATE_KEY)){
    localStorage.setItem(STATE_KEY, JSON.stringify({version:1,savedAt:Date.now(),settings:{},projects:[]}));
  }
  renderRoute(); loadSettingsIntoUI(); renderProjects(); wireNewForm(); renderConnections(); bindGlobalMenuClose();
});

function getState(){ try{ return JSON.parse(localStorage.getItem(STATE_KEY)||'{}') }catch{ return {settings:{},projects:[]} } }
function setState(next){ localStorage.setItem(STATE_KEY, JSON.stringify({version:1, savedAt:Date.now(), settings: next.settings||{}, projects: next.projects||[]})); }
function getSettings(){ return getState().settings||{}; }
function setSettings(s){ const st=getState(); st.settings=s||{}; setState(st); }
function loadProjects(){ return getState().projects||[]; }
function saveProjects(arr){ const st=getState(); st.projects=Array.isArray(arr)?arr:[]; setState(st); }

function routeEls(){return document.querySelectorAll('.route')}
function renderRoute(){
  const hash = location.hash.replace('#/','') || 'dashboard';
  const [route, query] = hash.split('?');
  routeEls().forEach(sec=>sec.hidden=true);
  const found = routes.includes(route) ? route : 'dashboard';
  document.querySelector(`[data-route="${found}"]`).hidden=false;
  document.querySelectorAll('.nav a').forEach(a=>a.setAttribute('aria-current', a.getAttribute('href')===`#/${found}`?'page':'false'));
  if(found==='preview'){ renderPreview(new URLSearchParams(query||'')); }
  if(found==='new'){ resetNewFormUI(); }
  $('#main').focus();
}

function uuid(){return 'p-'+Math.random().toString(36).slice(2,8)+'-'+Date.now().toString(36)}
function slugify(s){return (s||'').toLowerCase().replace(/[^a-z0-9-]+/g,'-').replace(/^-+|-+$/g,'').slice(0,60)||'site'}
function escapeHtml(s=''){return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}

function renderProjects(){
  const list=loadProjects(); const ul=$('#projects-list'); ul.innerHTML='';
  $('#projects-empty').hidden=list.length>0;
  for(const p of list){
    const li=document.createElement('li'); li.className='card';
    li.innerHTML=`
      <div class="menu-wrap">
        <button class="menu-btn" aria-haspopup="true" aria-expanded="false" aria-controls="menu-${p.id}" data-menu-btn data-id="${p.id}" title="Más acciones">⋮</button>
        <div class="menu" id="menu-${p.id}" role="menu" aria-hidden="true">
          <button role="menuitem" data-act="view" data-id="${p.id}">Ver</button>
          <button role="menuitem" data-act="zip" data-id="${p.id}">Descargar ZIP</button>
          <button role="menuitem" data-act="push" data-id="${p.id}">Push a GitHub</button>
          <button role="menuitem" data-act="deploy-real" data-id="${p.id}">Deploy en Netlify</button>
          <hr style="border:none;height:1px;background:#2b3b77;margin:6px 4px">
          <button role="menuitem" class="danger" data-act="delete" data-id="${p.id}">Eliminar</button>
        </div>
      </div>
      <h3 style="padding-right:36px">${p.name}</h3>
      <p>${p.desc||''}</p>
      <div class="row" style="margin-bottom:8px"><span class="tag">${p.status||'local'}</span>${p.repo?`<span class="tag">${p.repo}</span>`:''}</div>
      <div class="row">
        <button class="btn" data-act="view" data-id="${p.id}">Ver sitio</button>
        <button class="btn" data-act="zip" data-id="${p.id}">Descargar ZIP</button>
        <button class="btn" data-act="push" data-id="${p.id}">Push a GitHub</button>
        <button class="btn" data-act="deploy-real" data-id="${p.id}">Deploy Netlify</button>
      </div>`;
    ul.appendChild(li);
  }

  ul.querySelectorAll('[data-menu-btn]').forEach(btn=>{
    btn.onclick=(e)=>{
      const id=btn.dataset.id;
      const menu=ul.querySelector('#menu-'+CSS.escape(id));
      const open = menu.getAttribute('aria-hidden')==='false';
      closeAllMenus();
      if(!open){ menu.setAttribute('aria-hidden','false'); btn.setAttribute('aria-expanded','true'); }
      e.stopPropagation();
    };
  });

  ul.onclick=async(e)=>{
    const btn=e.target.closest('button[data-act]'); if(!btn) return;
    const id=btn.dataset.id; const proj=loadProjects().find(x=>x.id===id); if(!proj) return;
    const action=btn.dataset.act;
    closeAllMenus();
    if(action==='view'){ openPreview(proj); }
    if(action==='zip'){
      const blob=makeZip(proj.files); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`${proj.name}.zip`; a.click(); URL.revokeObjectURL(a.href);
    }
    if(action==='push'){
      await doPush(proj);
    }
    if(action==='deploy-real'){
      await doDeploy();
    }
    if(action==='delete'){
      if(confirm('¿Seguro que quieres borrar este proyecto?')){ deleteProject(id); renderProjects(); }
    }
  };
}

function closeAllMenus(){
  document.querySelectorAll('.menu').forEach(m=>m.setAttribute('aria-hidden','true'));
  document.querySelectorAll('[data-menu-btn]').forEach(b=>b.setAttribute('aria-expanded','false'));
}
function bindGlobalMenuClose(){
  document.addEventListener('click', (e)=>{
    if(!e.target.closest('.menu') && !e.target.closest('[data-menu-btn]')) closeAllMenus();
  });
}
function deleteProject(id){
  const list=loadProjects().filter(p=>p.id!==id);
  saveProjects(list);
}

const CRC_TABLE=(()=>{let c,t=[];for(let n=0;n<256;n++){c=n;for(let k=0;k<8;k++){c=c&1?0xedb88320^(c>>>1):c>>>1}t[n]=c>>>0}return t})();
function crc32Uint8(a){let c=0xffffffff;for(let i=0;i<a.length;i++){c=CRC_TABLE[(c^a[i])&0xff]^(c>>>8)}return (c^0xffffffff)>>>0}
function strToU8(s){return new TextEncoder().encode(s)}
function writeU16(v,o,x){v.setUint16(o,x,true);return o+2}
function writeU32(v,o,x){v.setUint32(o,x,true);return o+4}
function dosTimeDate(d=new Date()){const t=((d.getHours()&0x1f)<<11)|((d.getMinutes()&0x3f)<<5)|((Math.floor(d.getSeconds()/2))&0x1f);const da=(((d.getFullYear()-1980)&0x7f)<<9)|(((d.getMonth()+1)&0xf)<<5)|((d.getDate())&0x1f);return{time:t,date:da}}
function makeZip(files){
  const names=Object.keys(files||{});
  const fileRecords=[];
  let localSize=0;
  const chunks=[];
  for(const name of names){
    const nameU8=strToU8(name);
    const dataU8=strToU8(files[name]);
    const crc=crc32Uint8(dataU8);
    const {time,date}=dosTimeDate(new Date());
    const need=30+nameU8.length+dataU8.length;
    const buf=new ArrayBuffer(need);
    const view=new DataView(buf); let off=0;
    off=writeU32(view,off,0x04034b50);
    off=writeU16(view,off,20);
    off=writeU16(view,off,0);
    off=writeU16(view,off,0);
    off=writeU16(view,off,time);
    off=writeU16(view,off,date);
    off=writeU32(view,off,crc);
    off=writeU32(view,off,dataU8.length);
    off=writeU32(view,off,dataU8.length);
    off=writeU16(view,off,nameU8.length);
    off=writeU16(view,off,0);
    new Uint8Array(buf,off,nameU8.length).set(nameU8); off+=nameU8.length;
    new Uint8Array(buf,off,dataU8.length).set(dataU8); off+=dataU8.length;
    chunks.push(new Uint8Array(buf));
    fileRecords.push({nameU8,crc,size:dataU8.length,compSize:dataU8.length,time,date,localHeaderOffset:localSize});
    localSize+=need;
  }
  const centralChunks=[]; let centralSize=0;
  for(const rec of fileRecords){
    const need=46+rec.nameU8.length;
    const buf=new ArrayBuffer(need);
    const view=new DataView(buf); let off=0;
    off=writeU32(view,off,0x02014b50);
    off=writeU16(view,off,20);
    off=writeU16(view,off,20);
    off=writeU16(view,off,0);
    off=writeU16(view,off,0);
    off=writeU16(view,off,rec.time);
    off=writeU16(view,off,rec.date);
    off=writeU32(view,off,rec.crc);
    off=writeU32(view,off,rec.compSize);
    off=writeU32(view,off,rec.size);
    off=writeU16(view,off,rec.nameU8.length);
    off=writeU16(view,off,0);
    off=writeU16(view,off,0);
    off=writeU16(view,off,0);
    off=writeU16(view,off,0);
    off=writeU32(view,off,0);
    off=writeU32(view,off,rec.localHeaderOffset);
    new Uint8Array(buf,off,rec.nameU8.length).set(rec.nameU8); off+=rec.nameU8.length;
    centralChunks.push(new Uint8Array(buf));
    centralSize+=need;
  }
  const endBuf=new ArrayBuffer(22);
  const endView=new DataView(endBuf); let off=0;
  off=writeU32(endView,off,0x06054b50);
  off=writeU16(endView,off,0);
  off=writeU16(endView,off,0);
  off=writeU16(endView,off,fileRecords.length);
  off=writeU16(endView,off,fileRecords.length);
  off=writeU32(endView,off,centralSize);
  off=writeU32(endView,off,localSize);
  off=writeU16(endView,off,0);
  const totalLen=localSize+centralSize+22;
  const out=new Uint8Array(totalLen);
  let pos=0; for(const c of chunks){ out.set(c,pos); pos+=c.length; }
  for(const c of centralChunks){ out.set(c,pos); pos+=c.length; }
  out.set(new Uint8Array(endBuf),pos);
  return new Blob([out],{type:'application/zip'});
}

function getSettingsSafe(){ try { return (JSON.parse(localStorage.getItem(STATE_KEY)||'{}').settings)||{} } catch { return {}; } }
function buildOpenAIHeaders(){
  const headers = {'Content-Type':'application/json','Accept':'application/json'};
  if(!IS_PROD){
    const st = getSettingsSafe();
    if(st.openaiKey) headers['x-openai-key'] = st.openaiKey;
    if(st.openaiAsst) headers['x-openai-asst'] = st.openaiAsst;
  }
  return headers;
}

function generateSite({name,prompt}){
  const dark=/oscuro|dark/i.test(prompt); const accent=(getSettings().accent)||'#7aa2ff';
  const css=`:root{--ink:${dark?'#f2f4ff':'#111'};--bg:${dark?'#0b0f1c':'#fff'};--pri:${accent}}body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.65 system-ui}`;
  const body=`<main class="wrap"><h1>${escapeHtml(name)}</h1><p>${escapeHtml(prompt)}</p></main>`;
  return {files:{'index.html':`<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>${escapeHtml(name)}</title><style>${css}</style></head><body>${body}</body></html>`}};
}
function localEdit(files, promptText){
  const src = files['index.html']||'<html><body><h1>Sin index.html</h1></body></html>';
  let out = src;
  if(/oscuro|dark/i.test(promptText)){ out = out.replace('<style>', '<style>body{background:#0b0f1c;color:#f2f4ff;}'); }
  out = out.replace('</body>', `<section style="padding:24px;border-top:1px solid #ddd"><h3>Cambio aplicado</h3><p>${escapeHtml(promptText||'Actualización')}</p></section></body>`);
  return {...files, 'index.html': out};
}

function wireNewForm(){
  const form=$('#new-form'); const info=$('#form-info'); const errors=$('#form-errors');
  $('#preview-btn').onclick=()=>{
    const prompt=$('#prompt').value.trim(); const name=$('#name').value.trim()||'proyecto';
    if(!prompt){ errors.hidden=false; errors.textContent='El prompt es requerido.'; return; }
    const gen=generateSite({name,prompt}); const iframe=$('#preview');
    iframe.src=URL.createObjectURL(new Blob([gen.files['index.html']],{type:'text/html'}));
    $('#local-preview').hidden=false; info.hidden=false; info.textContent='Preview local generado.'; errors.hidden=true;
  };
  form.onsubmit=async(e)=>{
    e.preventDefault();
    const prompt=$('#prompt').value.trim(); const name=$('#name').value.trim(); const desc=$('#desc').value.trim();
    if(!prompt||!name){ errors.hidden=false; errors.textContent='Prompt y Nombre son obligatorios.'; return; }
    const slug=slugify(name); const id=uuid();
    let files;
    try{
      const r=await fetch('/.netlify/functions/generate',{method:'POST',headers:buildOpenAIHeaders(),body:JSON.stringify({prompt,name})});
      const data=await r.json(); if(!r.ok) throw new Error(data.error||'Error de generación'); files = data.files;
    }catch(err){
      files = generateSite({name,prompt}).files;
    }
    const list=loadProjects(); list.unshift({id,name,slug,desc,status:'generated',files,createdAt:Date.now()}); saveProjects(list);
    form.reset(); $('#local-preview').hidden=true; info.hidden=true; errors.hidden=true;
    location.hash = `#/preview?id=${encodeURIComponent(id)}`;
  };
}
function resetNewFormUI(){ const form=$('#new-form'); if(!form) return; form.reset(); $('#form-info').hidden=true; $('#form-errors').hidden=true; $('#local-preview').hidden=true; }

function openPreview(proj){ location.hash = `#/preview?id=${encodeURIComponent(proj.id)}`; }
function getProjectById(id){ return loadProjects().find(p=>p.id===id); }
function renderPreview(params){
  const id = params.get('id'); const proj = id ? getProjectById(id) : null;
  const pvTitle = $('#pv-title'); const pvInfo=$('#pv-info'); const pvErr=$('#pv-error');
  if(!proj){ location.hash='#/dashboard'; return; }
  pvTitle.textContent = `Preview — ${proj.name}`;
  const iframe = $('#pv-iframe');
  const html = (proj.files && proj.files['index.html']) ? proj.files['index.html'] : '<h1>Sin index.html</h1>';
  iframe.src = URL.createObjectURL(new Blob([html],{type:'text/html'}));
  $('#pv-download').onclick=()=>{ const blob=makeZip(proj.files||{}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`${proj.name}.zip`; a.click(); URL.revokeObjectURL(a.href); };
  $('#pv-apply-ai').onclick = async ()=>{
    pvInfo.hidden=false; pvInfo.textContent='Aplicando cambios con IA...'; pvErr.hidden=true;
    try{
      const prompt = ($('#pv-prompt').value||'').trim(); if(!prompt) throw new Error('Escribe un prompt');
      const r = await fetch('/.netlify/functions/generate', { method:'POST', headers: buildOpenAIHeaders(), body: JSON.stringify({ mode:'edit', prompt, name: proj.name, files: proj.files }) });
      const data = await r.json(); if(!r.ok || !data.files) throw new Error(data.error||'La función no devolvió archivos');
      updateProjectFiles(proj.id, data.files); renderPreview(new URLSearchParams(`id=${encodeURIComponent(proj.id)}`)); pvInfo.textContent='Cambios aplicados (IA).';
    }catch(err){ pvInfo.hidden=true; pvErr.hidden=false; pvErr.textContent='Error: '+err.message; }
  };
  $('#pv-apply-local').onclick = ()=>{
    const txt = ($('#pv-prompt').value||'').trim();
    const updated = localEdit(proj.files||{}, txt);
    updateProjectFiles(proj.id, updated);
    renderPreview(new URLSearchParams(`id=${encodeURIComponent(proj.id)}`));
    pvInfo.hidden=false; pvInfo.textContent='Cambios aplicados (local).'; pvErr.hidden=true;
  };
}
function updateProjectFiles(id, newFiles){ const list=loadProjects(); const i=list.findIndex(p=>p.id===id); if(i<0) return; list[i].files=newFiles; list[i].status='edited'; saveProjects(list); renderProjects(); }

function loadSettingsIntoUI(){
  const st=getSettings();
  if(st.accent){ $('#color-accent').value=st.accent; document.documentElement.style.setProperty('--pri',st.accent); }
  $('#secrets-local').hidden = IS_PROD;
  $('#secrets-prod').hidden = !IS_PROD;
  if(!IS_PROD){
    if(st.ghToken) $('#gh-token').value = st.ghToken;
    if(st.netlifyToken) $('#netlify-token').value = st.netlifyToken;
    if(st.openaiKey) $('#openai-key').value = st.openaiKey;
    if(st.openaiAsst) $('#openai-asst').value = st.openaiAsst;
  }
  if(st.ghOwner) $('#gh-owner').value = st.ghOwner;
  if(st.ghRepo) $('#gh-repo').value = st.ghRepo;
  if(st.netlifySiteId) $('#netlify-site').value = st.netlifySiteId;
  if(st.netlifyHook) $('#netlify-hook').value = st.netlifyHook;

  $('#save-settings').onclick=()=>{
    const next={
      accent: $('#color-accent').value,
      ghOwner: $('#gh-owner').value.trim(),
      ghRepo: $('#gh-repo').value.trim(),
      netlifySiteId: $('#netlify-site').value.trim(),
      netlifyHook: $('#netlify-hook').value.trim()
    };
    if(!IS_PROD){
      next.ghToken = ($('#gh-token').value||'').trim();
      next.netlifyToken = ($('#netlify-token').value||'').trim();
      next.openaiKey = ($('#openai-key').value||'').trim();
      next.openaiAsst = ($('#openai-asst').value||'').trim();
    }
    setSettings(next);
    document.documentElement.style.setProperty('--pri',next.accent||'#7aa2ff');
    flashInfo('Preferencias guardadas');
    renderConnections();
  };

  $('#toggle-visibility').onclick=()=>{
    const inputs=[...document.querySelectorAll('#secrets-local input[type="password"]')];
    if(!inputs.length) return;
    const show = inputs.some(i=>i.type==='password');
    inputs.forEach(i=>i.type= show ? 'text' : 'password');
    $('#toggle-visibility').textContent = show ? 'Ocultar' : 'Mostrar';
  };

  $('#export-all').onclick=()=>{
    const payload = {...getState(), exportedAt: Date.now()};
    const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='project-central-export.json'; a.click(); URL.revokeObjectURL(a.href);
  };
  $('#import-all').onclick=()=> $('#import-file').click();
  $('#import-file').onchange=(e)=>{
    const file=e.target.files[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload=()=>{
      try{
        const incoming=JSON.parse(reader.result);
        const overwrite = confirm('¿Sobrescribir TODO? Cancel = MERGE.');
        if(overwrite){ setState({settings: incoming.settings||{}, projects: incoming.projects||[]}); }
        else{
          const cur=getState();
          const mergedSettings = {...cur.settings, ...(incoming.settings||{})};
          const map=new Map(); (cur.projects||[]).forEach(p=>map.set(p.id,p)); (incoming.projects||[]).forEach(p=>map.set(p.id,p));
          setState({settings: mergedSettings, projects: Array.from(map.values())});
        }
        loadSettingsIntoUI(); renderProjects(); renderConnections(); flashInfo('Importación completada');
      }catch(err){ flashError('Error importando: '+err.message); }
    };
    reader.readAsText(file);
  };
  $('#clear-all').onclick=()=>{ if(confirm('¿Borrar TODOS los settings y proyectos?')){ setState({settings:{},projects:[]}); loadSettingsIntoUI(); renderProjects(); renderConnections(); flashInfo('Todo borrado'); } };
}
function flashInfo(msg){ const el=$('#settings-info'); el.hidden=false; el.textContent=msg; setTimeout(()=>el.hidden=true, 2000); }
function flashError(msg){ const el=$('#settings-errors'); el.hidden=false; el.textContent=msg; setTimeout(()=>el.hidden=true, 4000); }

function renderConnections(){
  const st=getSettings(); const wrap=$('#conn-cards');
  const items=[
    {name:'GitHub', ok: IS_PROD ? true : !!st.ghToken},
    {name:'Netlify', ok: IS_PROD ? true : (!!st.netlifyToken||!!st.netlifyHook)},
    {name:'OpenAI (server)', ok: IS_PROD ? true : !!st.openaiKey}
  ];
  wrap.innerHTML=items.map(i=>`<div class="card"><h3>${i.name}</h3><p>${i.ok?'OK':'Sin configurar'}</p></div>`).join('');
}

async function doPush(proj){
  try{
    const r = await fetch('/.netlify/functions/push-to-github', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id: proj.id, name: proj.name, files: proj.files })});
    const data = await r.json();
    if(!r.ok) throw new Error(data.error||'Error en push');
    alert('Push a GitHub completado');
  }catch(err){ alert('Push falló: '+err.message); }
}
async function doDeploy(){
  try{
    const r = await fetch('/.netlify/functions/trigger-deploy', {method:'POST'});
    const data = await r.json();
    if(!r.ok) throw new Error(data.error||'Error en deploy');
    alert('Deploy de Netlify lanzado');
  }catch(err){ alert('Deploy falló: '+err.message); }
}

document.querySelectorAll('[data-carousel]').forEach(initCarousel);

function initCarousel(root){
  const track = root.querySelector('.track');
  const slides = [...track.children];
  const prev = root.querySelector('[data-prev]');
  const next = root.querySelector('[data-next]');
  const dots = root.querySelector('[data-dots]');
  if(!track || !slides.length || !prev || !next || !dots) return;

  let i = 0;

  // Dots
  slides.forEach((_, idx) => {
    const b = document.createElement('button');
    b.setAttribute('aria-label', `Ir a la diapositiva ${idx+1}`);
    b.addEventListener('click', () => go(idx));
    dots.appendChild(b);
  });

  // Go to index
  function go(n){
    i = (n + slides.length) % slides.length;
    track.style.transform = `translateX(${i * -100}%)`;
    [...dots.children].forEach((b, bi) => b.classList.toggle('is-active', bi === i));
  }

  // Controles
  prev.addEventListener('click', () => go(i - 1));
  next.addEventListener('click', () => go(i + 1));
  root.addEventListener('keydown', e => {
    if (e.key === 'ArrowLeft') prev.click();
    if (e.key === 'ArrowRight') next.click();
  });

  // Tacto (swipe ligero)
  let x0 = null;
  root.addEventListener('pointerdown', e => (x0 = e.clientX), {passive:true});
  root.addEventListener('pointerup', e => {
    if (x0 == null) return;
    const dx = e.clientX - x0;
    if (Math.abs(dx) > 40) (dx > 0 ? prev : next).click();
    x0 = null;
  }, {passive:true});

  // Grid de columnas = nº de slides
  track.style.gridTemplateColumns = `repeat(${slides.length}, 100%)`;
  go(0);
}

document.querySelectorAll('.faq .faq-q').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const open = btn.getAttribute('aria-expanded') === 'true';
    btn.setAttribute('aria-expanded', String(!open));
    btn.nextElementSibling.hidden = open;
  });
});


</script>
</body>
</html>
